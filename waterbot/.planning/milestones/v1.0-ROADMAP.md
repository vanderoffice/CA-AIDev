# Milestone v1.0: Actionable Knowledge Base

**Status:** SHIPPED 2026-02-11
**Phases:** 1-5
**Total Plans:** 13

## Overview

Transform WaterBot from a factually accurate but link-poor knowledge base into one where every response is both accurate AND actionable. The journey: build a master URL registry, rewrite all content with inline links and "Take Action" sections, rebuild the database, update the n8n system prompt to surface links, then validate everything against the existing adversarial baseline.

## Phases

### Phase 1: URL Registry & Validation

**Goal**: Build a structured JSON registry mapping every WaterBot topic to 2-5 verified, actionable URLs — the single source of truth for all links in the knowledge base
**Depends on**: Nothing (first phase)
**Plans**: 4 plans

Plans:
- [x] 01-01: Registry schema, topic inventory, existing URL extraction, CA gov site mapping
- [x] 01-02: Populate URLs for core topics (water quality, permits, compliance, regional boards)
- [x] 01-03: Populate URLs for remaining topics (programs, funding, consumer, public resources, small systems, advocacy, water supply)
- [x] 01-04: Validate all registry URLs (HTTP 200), fix broken links, finalize registry

**Details:**
- Registry schema: JSON with 179 topics across 11 categories
- CA gov site map covering SWRCB, DDW, regional boards, SAFER, DWR, etc.
- URL validation: HTTP HEAD/GET checks, redirect resolution, broken link fixes
- Final registry: 500+ URLs, all validated

### Phase 2: Content Overhaul

**Goal**: Rewrite all 33 batch JSON files with inline URLs from the registry, fact-check every claim against current CA sources, and add "Take Action" sections guiding residents to next steps
**Depends on**: Phase 1 (URL registry must exist before embedding links in content)
**Plans**: 4 plans

Plans:
- [x] 02-01: Rewrite core batch files — consumer FAQ, permits & compliance, pollutants (8 files)
- [x] 02-02: Rewrite program & funding batch files — programs, public resources, funding guides (9 files)
- [x] 02-03: Rewrite specialized batch files — conservation, advocacy, operator guides, regional boards (8 files)
- [x] 02-04: Rewrite remaining batch files — gap filler, additional/final topics, small systems (8 files)

**Details:**
- Every content file rewritten with inline URLs from registry
- "Take Action" sections added to guide residents to next steps
- Facts, dates, figures verified against current CA sources
- 33 files, 179 documents total

### Phase 3: DB Rebuild

**Goal**: Execute a full database rebuild from the overhauled content — re-embed all documents, reingest via SSH pipeline, rebuild IVFFlat index
**Depends on**: Phase 2 (all content must be finalized before rebuilding)
**Plans**: 2 plans

Plans:
- [x] 03-01: DB strategy assessment — clean slate vs preserve+enhance, based on content quality delta
- [x] 03-02: Execute rebuild — run ingestion pipeline, re-embed, reingest, reindex IVFFlat

**Details:**
- Strategy decision: Clean-slate (TRUNCATE + re-ingest) — old content fully superseded (6.2% links vs 100% new)
- Result: 1,286 → 179 rows, all with embedded URLs
- IVFFlat index rebuilt for optimal similarity search
- Pipeline: `ingest_waterbot_content.py` → OpenAI embeddings → SSH/Docker/psql

### Phase 4: System Prompt & n8n Integration

**Goal**: Update WaterBot's n8n workflow system prompt to explicitly instruct the LLM to extract and surface URLs from retrieved context in its responses
**Depends on**: Phase 3 (DB must contain URL-rich content before testing prompt changes)
**Plans**: 1 plan

Plans:
- [x] 04-01: Update system prompt with link-surfacing instructions, test with sample queries

**Details:**
- n8n workflow MY78EVsJL00xPMMw updated
- System prompt now instructs LLM to extract and present URLs from retrieved context
- maxTokens 2000, temperature 0.2 for consistent link-rich responses

### Phase 5: Evaluation & Regression

**Goal**: Prove the overhaul improved WaterBot — run full adversarial eval, validate all URLs in DB, compare to baseline (33/35 strong), ensure no regression
**Depends on**: Phase 4 (all changes must be in place before final evaluation)
**Plans**: 2 plans

Plans:
- [x] 05-01: Full adversarial evaluation and URL validation across entire DB
- [x] 05-02: Regression analysis, baseline comparison, final documentation

**Details:**
- Adversarial eval: 35/35 STRONG (100%), up from 33/35 (94.3%)
- Both weak spots resolved: wat-015 chromium-6 (0.339→0.625), wat-017 CCR (0.366→0.589)
- Average similarity: 0.5636→0.5944 (+0.031)
- URL validation: 313 unique URLs in DB, 97.1% reachable
- Zero regressions on existing 35 queries
- Full regression report: `.planning/phases/05-evaluation/regression_report.md`

---

## Milestone Summary

**Key Decisions:**
- WaterBot only (not all 3 bots) — focus delivers better quality than spreading
- URL registry as structured JSON — single source of truth for link maintenance
- DB rebuild: clean-slate (TRUNCATE + re-ingest) — old content fully superseded
- Inline URLs in content (not just metadata) — embeddings include URL text, LLM sees links
- Baseline comparison at every phase — measurable improvement, not just "we changed things"

**Issues Resolved:**
- wat-015 chromium-6 weak retrieval (0.339→0.625 STRONG)
- wat-017 CCR weak retrieval (0.366→0.589 STRONG)
- "Conservation as a Way of Life" partially resolved (0.387 ACCEPTABLE — phrasing issue, not content gap)
- "File complaint" resolved (0.608 STRONG — Phase 3 rebuild filled gap)

**Issues Deferred:**
- BizBot/KiddoBot overhaul — separate project using same pattern
- `file_name` metadata null in some rows — cosmetic, by design

**Technical Debt Incurred:**
- Two metadata schemas coexist: markdown-chunked and batch JSON (functional, not harmful)
- 9 URLs (2.9%) returned non-200 status — CA gov site instability, not content issue

---

_For current project status, see .planning/ROADMAP.md_
