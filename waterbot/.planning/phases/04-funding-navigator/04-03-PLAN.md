---
phase: 04-funding-navigator
plan: 03
type: execute
---

<objective>
Build the full results display with tiered program cards, RAG enrichment, and "Ask WaterBot" handoff — completing the Funding Navigator end-to-end.

Purpose: Give users a polished, informative results screen showing matched funding programs with eligibility details and AI-enriched context.
Output: Complete Funding Navigator with ResultCard rendering, tier sections, RAG bridge, AskWaterBot handoff. Phase 4 complete.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries:
@.planning/phases/01-shared-infrastructure/01-02-SUMMARY.md
@.planning/phases/02-permit-finder/02-03-SUMMARY.md
@.planning/phases/04-funding-navigator/04-01-SUMMARY.md
@.planning/phases/04-funding-navigator/04-02-SUMMARY.md

# Key source files:
@src/components/FundingNavigator.jsx
@src/components/ResultCard.jsx
@src/components/AskWaterBot.jsx
@src/components/PermitFinder.jsx
@src/utils/matchFundingPrograms.js

**Tech stack available:** React 18 + Vite + Tailwind, hand-crafted SVG icons
**Established patterns:**
- ResultCard: title, code, description, agency, link, details (grid), requirements, nextSteps, ragQuery, onAskWaterBot
- Async RAG enrichment: fire webhook on result view, AbortController cleanup, WaterBot Insights card
- Non-blocking: ResultCards render first, enrichment loads async below
- Simple paragraph splitting (double newline) for RAG response text

**Constraining decisions:**
- [01-02]: ResultCard uses local useState for expandable toggles
- [02-03]: RAG fetch is non-blocking — static content renders first
- [02-03]: Simple paragraph splitting instead of markdown parser
- [02-03]: AbortController cleanup prevents state-update-on-unmounted warnings
- [PROJECT]: "Ask WaterBot" escape hatch on all results
</context>

<tasks>

<task type="auto">
  <name>Task 1: Render matched programs as ResultCards with tier sections</name>
  <files>src/components/FundingNavigator.jsx</files>
  <action>
Replace the summary-count placeholder results view with full program card rendering:

**Results layout structure:**
```
Results Header (total count + "Based on your answers")
├── Tier Section: Eligible (green accent)
│   ├── Tier badge + count
│   └── ResultCard for each program
├── Tier Section: Likely Eligible (amber accent)
│   ├── Tier badge + count
│   └── ResultCard for each program
├── Tier Section: May Qualify (neutral accent)
│   ├── Tier badge + count
│   └── ResultCard for each program
├── Empty state (if zero matches across all tiers)
└── Search Again button
```

**Tier section rendering:**
- Only render tier sections that have programs (skip empty tiers)
- Each tier section has a colored header bar:
  - Eligible: `bg-emerald-500/10 border-emerald-500/30 text-emerald-400`
  - Likely Eligible: `bg-amber-500/10 border-amber-500/30 text-amber-400`
  - May Qualify: `bg-neutral-500/10 border-neutral-500/30 text-neutral-400`
- Show count: "X Programs" in the tier header

**ResultCard props mapping (from funding program object):**
- `title` → `program.name`
- `code` → `program.abbreviation` (if exists, else null)
- `description` → `program.description`
- `agency` → `program.administeredBy`
- `link` → `program.programUrl`
- `details` → Build from program fields:
  - `fundingRange`: Format as string from `program.fundingRange` (e.g., "$150K – $5M" or "Up to $X" or range notes)
  - `deadline`: null (funding programs don't have deadlines in our data — omit)
  - Add custom detail: funding type label from `program.fundingType` (Grant, Loan, Loan & Grant, etc.)
- `requirements` → `program.eligibility.additionalCriteria` (string array)
- `nextSteps` → Build from match data: include `program.matchReasons` (what matched) — but present as informational, not actionable steps
- `ragQuery` → `program.ragQuery`
- `onAskWaterBot` → props.onAskWaterBot

**Match info display (above or below ResultCard):**
For each program card, show match reasons as small tags:
- `matchReasons` → render as subtle info tags (e.g., "Matches: treatment, distribution")
- `barriers` → render as amber warning text (e.g., "Note: Requires 25% matching funds")

**Empty state (zero total matches):**
Show a friendly message: "No programs matched your specific criteria. Try broadening your project types or check the links below for all available programs." Include an AskWaterBot handoff with query "What water infrastructure funding programs are available in California?"

**Search Again button:** at the bottom, calls `restart()` — same style as PermitFinder's "Start New Search" button.

**What to avoid:** Do NOT add RAG enrichment yet (Task 2). Do NOT change the matching algorithm or questionnaire. Do NOT create new shared components — use existing ResultCard. The DETAIL_LABELS map in ResultCard.jsx already supports `fundingRange` — use that key.
  </action>
  <verify>`npm run build` succeeds. Complete questionnaire → tiered program cards render with correct data. Empty tiers hidden. Search Again resets.</verify>
  <done>Matched programs display as ResultCards organized by eligibility tier with colored headers, match reasons, barriers, and program details.</done>
</task>

<task type="auto">
  <name>Task 2: Add RAG enrichment and AskWaterBot handoff</name>
  <files>src/components/FundingNavigator.jsx</files>
  <action>
Add the RAG bridge following PermitFinder's established async enrichment pattern:

**RAG enrichment (reuse PermitFinder's exact pattern):**

1. Add RAG state variables:
   ```
   const [ragResponse, setRagResponse] = useState(null)
   const [ragSources, setRagSources] = useState(null)
   const [ragLoading, setRagLoading] = useState(false)
   const [ragError, setRagError] = useState(false)
   ```

2. Add RAG webhook constant: `const RAG_WEBHOOK_URL = 'https://n8n.vanderdev.net/webhook/waterbot'`

3. Add useEffect that fires when `showResults` becomes true:
   - Build a RAG query from the user's answers, e.g.: "What funding programs are available for [entityType] working on [projectTypes] serving [populationServed] people?"
   - Fire fetch to RAG_WEBHOOK_URL with `{ message: ragQuery, sessionId, messageHistory: [] }`
   - Use AbortController for cleanup (cancel on unmount or when user restarts)
   - Set ragResponse/ragSources/ragError on completion

4. Render WaterBot Insights card BELOW the tier sections (same as PermitFinder):
   - Loading state: spinner + "Getting additional context from WaterBot..."
   - Success state: "WaterBot Insights" card with response paragraphs (split on \n\n) and source links
   - Error state: "Additional context unavailable" italic text
   - Copy the exact JSX structure from PermitFinder lines ~226-276

5. Reset RAG state when user restarts (in the restart function).

**AskWaterBot integration:**
- Each ResultCard already has `ragQuery` and `onAskWaterBot` props from Task 1 — individual card handoff is done
- Add a standalone AskWaterBot button in the results footer (between results and "Search Again") with a general funding query: "Tell me more about water infrastructure funding options for my project"

**What to avoid:** Do NOT create a separate RAG utility — keep the fetch inline in FundingNavigator (same pattern as PermitFinder). Do NOT change the RAG webhook contract. Do NOT add markdown parsing — use simple paragraph splitting.
  </action>
  <verify>`npm run build` succeeds. Complete questionnaire → programs display → WaterBot Insights card loads async below results. AskWaterBot handoff switches to chat mode. Restarting clears RAG state.</verify>
  <done>RAG enrichment loads async on results view. WaterBot Insights card shows AI context. AskWaterBot handoff works from both individual cards and footer button. Phase 4 complete.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] Full end-to-end flow: landing → 5 questions → tiered results → RAG enrichment → AskWaterBot → chat mode
- [ ] Eligible / Likely Eligible / May Qualify tiers display with correct color coding
- [ ] ResultCards show program name, abbreviation, description, agency, link, funding details
- [ ] Match reasons and barriers display for each program
- [ ] RAG enrichment loads async and displays WaterBot Insights card
- [ ] AskWaterBot handoff works from individual cards and footer
- [ ] Search Again resets everything cleanly
- [ ] Back navigation from results returns to last question
- [ ] Empty state handles zero matches gracefully
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors or warnings introduced
- Funding Navigator is fully functional end-to-end
- RAG enrichment follows PermitFinder's established pattern exactly
- Phase 4 complete — ready for Phase 5 (Integration & Polish)
</success_criteria>

<output>
After completion, create `.planning/phases/04-funding-navigator/04-03-SUMMARY.md`
</output>
