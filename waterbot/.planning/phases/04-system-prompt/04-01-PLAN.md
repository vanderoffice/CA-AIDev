---
phase: 04-system-prompt
plan: 01
type: execute
---

<objective>
Update WaterBot's n8n workflow system prompt to explicitly instruct the LLM to extract and surface URLs from retrieved context, so every response includes actionable links.

Purpose: The DB now contains 179 docs with 100% inline URL coverage and Take Action sections — but the LLM won't reliably surface those links unless the system prompt explicitly tells it to. This is the bridge between link-rich content and link-rich responses.
Output: Updated n8n workflow with link-surfacing system prompt, verified via test queries showing URLs in responses.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (Phase 3 — DB rebuild is direct dependency):
@.planning/phases/03-db-rebuild/03-02-SUMMARY.md

# Key project files:
@scripts/ingest_waterbot_content.py

**Tech stack available:** PostgreSQL 15.8.1, pgvector 0.8.0, n8n on VPS, OpenAI text-embedding-3-small
**Established patterns:**
- n8n workflow updates via SQL to BOTH `workflow_entity` AND `workflow_history` tables (dollar-quoting for safe JSON)
- Parse Request → Prepare Search → Build Prompt node chain in WaterBot workflow
- Build Prompt references `$('Prepare Search').first().json` for waterContext
- BizBot pattern: `## USER'S BUSINESS PROFILE` section added to system prompt (same approach for WaterBot)

**Constraining decisions:**
- Phase 03-02: DB rebuilt with 179 docs, 100% URL coverage, 100% Take Action sections, avg 2,811 chars
- Phase 03-01: Clean-slate rebuild — only batch JSON content exists in DB (no old chunked markdown)
- Content uses markdown link format: `[Label](URL)` — LLM must preserve this format in responses

**n8n Workflow:** `MY78EVsJL00xPMMw` (WaterBot - Chat)
**VPS DB access:** `ssh vps "docker exec -i supabase-db psql -U postgres -d postgres"`
**n8n DB access:** n8n stores workflows in its own PostgreSQL — access via n8n MCP tools or direct SSH

**waterContext structure (from IntakeForm):**
```json
{
  "userType": "homeowner|renter|operator|advocate|other",
  "primaryConcern": "water_quality|permit|funding|general",
  "waterSystem": "public|private_well|small_system|unknown",
  "county": "California county name"
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Retrieve current system prompt, design update, deploy to n8n</name>
  <files>No local files modified — n8n workflow lives on VPS</files>
  <action>
    **Step 1: Retrieve current workflow and extract system prompt.**
    Use n8n MCP tools (`n8n_get_workflow` with ID `MY78EVsJL00xPMMw`) to retrieve the full workflow JSON. Find the AI Agent or Build Prompt node that contains the system prompt. Save the current prompt text to `/tmp/waterbot_prompt_baseline.txt` as a reference for Phase 5 comparison.

    **Step 2: Design updated system prompt.**
    Add link-surfacing instructions to the existing system prompt. The additions must cover:

    1. **Link extraction mandate:** When retrieved context contains URLs (formatted as `[Label](URL)`), include the most relevant ones in the response. Prioritize links that directly help the user act on their question.

    2. **Take Action surfacing:** If retrieved context includes a "Take Action" section, incorporate those action steps with their links into the response. Present them as a clear numbered list of next steps.

    3. **User-type tailoring:** Prioritize links relevant to the user's profile from waterContext:
       - Operators → compliance portals, monitoring guides, permit applications
       - Residents/homeowners → complaint forms, testing resources, CCR lookup
       - Advocates → policy resources, board meeting info, public comment portals
       - Renters → tenant rights, shutoff protections, complaint hotlines

    4. **Link formatting:** Present links as labeled markdown links. Never show bare URLs. Group related links together.

    5. **URL accuracy guard:** ONLY include URLs that appear verbatim in the retrieved context. NEVER invent, guess, or hallucinate URLs. If no relevant URLs are in the context, do not fabricate any.

    Keep the existing waterContext profile section and all existing instructions intact. Add the link-surfacing block as a new section (e.g., `## LINK AND ACTION STEP INSTRUCTIONS`).

    **Step 3: Deploy updated prompt to n8n.**
    Use n8n MCP tools (`n8n_update_partial_workflow`) to update the Build Prompt / AI Agent node with the new system prompt text. If MCP tools are unavailable or fail, fall back to the established SSH/SQL pattern:
    - Update `workflow_entity` table
    - Update `workflow_history` table (BOTH must be updated — established pattern from prior workflow fixes)
    - Use dollar-quoting for safe JSON insertion

    **What to avoid and WHY:**
    - Do NOT remove or modify existing waterContext handling — it's working correctly (fixed in prior project phase)
    - Do NOT change the Parse Request or Prepare Search nodes — only the Build Prompt / system prompt node needs updating
    - Do NOT add instructions that conflict with the existing prompt structure — augment, don't replace
  </action>
  <verify>
    Retrieve the workflow again via n8n MCP and confirm the system prompt now contains link-surfacing instructions. Grep for key phrases: "Take Action", "URLs", "markdown links", "NEVER invent".
  </verify>
  <done>
    - Current baseline prompt saved to /tmp/waterbot_prompt_baseline.txt
    - Updated system prompt deployed to n8n workflow MY78EVsJL00xPMMw
    - Prompt contains all 5 link-surfacing instruction categories
    - Existing waterContext handling preserved unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Test updated prompt with sample queries</name>
  <files>No local files modified — testing against live workflow</files>
  <action>
    Execute 3-5 test queries against the WaterBot workflow to verify the LLM now surfaces URLs in responses. Use n8n MCP test execution or curl the webhook endpoint directly.

    **Test queries (chosen to cover different content types):**
    1. "How do I check if my tap water is safe?" — should surface CCR lookup, testing lab links, DDW portal
    2. "What are PFAS and should I be worried?" — should surface EPA PFAS info, DDW monitoring data, health advisory links
    3. "I want to file a complaint about my water company" — should surface complaint form links, SWRCB portal, regional board contacts
    4. "How can I get funding for my small water system?" — should surface SAFER program, SRF, FAAST application links
    5. "What permits do I need for stormwater discharge?" — should surface MS4 permit info, SWRCB portal, regional board links

    For each response, check:
    - Does the response contain at least 1 markdown-formatted URL?
    - Are the URLs from the retrieved context (not hallucinated)?
    - Does the response reference Take Action steps when available?
    - Is the response still accurate and helpful (no regression)?

    Document results in a simple pass/fail table.

    **What to avoid and WHY:**
    - Do NOT modify any content or DB data — this is read-only testing
    - If a test fails, do NOT immediately revert the prompt — document the failure for diagnosis
  </action>
  <verify>
    At least 4 of 5 test queries produce responses containing markdown-formatted URLs from retrieved context. No hallucinated URLs detected.
  </verify>
  <done>
    - 5 test queries executed
    - ≥4/5 responses contain relevant, non-hallucinated URLs
    - Results documented with pass/fail per query
    - No regression in response accuracy
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated WaterBot system prompt with link-surfacing instructions. Automated tests show URLs appearing in responses.</what-built>
  <how-to-verify>
    1. Visit: https://vanderdev.net/ecosform
    2. Start a WaterBot chat (select any intake form options)
    3. Ask: "How do I check my water quality?"
    4. Confirm: Response includes clickable links to CA gov portals (CCR lookup, testing labs, DDW)
    5. Ask: "I want to complain about my water company"
    6. Confirm: Response includes complaint form links and Take Action steps
    7. Verify: Links are real URLs from the knowledge base, not hallucinated
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Current system prompt baseline saved for Phase 5 comparison
- [ ] Updated system prompt deployed to n8n workflow MY78EVsJL00xPMMw
- [ ] ≥4/5 automated test queries return responses with URLs
- [ ] Human verification confirms links appear in live WaterBot chat
- [ ] No regression in response quality or accuracy
- [ ] Both workflow_entity and workflow_history updated (if SQL method used)
</verification>

<success_criteria>

- System prompt updated with link-surfacing instructions
- LLM responses consistently include relevant URLs from retrieved context
- Take Action sections surfaced in responses when applicable
- No hallucinated URLs in test responses
- No regression on response accuracy
- Phase 4 complete, ready for Phase 5 (Evaluation & Regression)
</success_criteria>

<output>
After completion, create `.planning/phases/04-system-prompt/04-01-SUMMARY.md`:

# Phase 4 Plan 1: System Prompt & n8n Integration Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- [Paths and descriptions]

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 5: Evaluation & Regression]
</output>
