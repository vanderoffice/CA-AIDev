---
phase: 02-permit-finder
plan: 03
type: execute
---

<objective>
Add RAG bridge enrichment to permit results — automatically query the n8n webhook with each result node's ragQuery to display additional knowledge base context alongside static permit details.

Purpose: Connect the Permit Finder to WaterBot's 1,401-chunk knowledge base, making results richer and more actionable than static data alone.
Output: Result screens that show both structured permit data (ResultCards) AND AI-generated context from the RAG pipeline, with graceful loading and error handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries:
@.planning/phases/02-permit-finder/02-01-SUMMARY.md
@.planning/phases/02-permit-finder/02-02-SUMMARY.md
@.planning/phases/01-shared-infrastructure/01-02-SUMMARY.md

# Key source files:
@src/components/PermitFinder.jsx
@src/pages/WaterBot.jsx
@src/components/Icons.jsx

**n8n webhook contract:**
- URL: `https://n8n.vanderdev.net/webhook/waterbot`
- Request: POST `{ message: string, sessionId: string, messageHistory: [] }`
- Response: `{ response: string, sources?: Array }`
- Same contract used by chat's sendMessage function in WaterBot.jsx

**ragQuery field:** Every result node in the decision tree has a `ragQuery` string designed to pull relevant context from the knowledge base. Example: "Construction General Permit CGP risk level 1 SWPPP requirements stormwater NOI SMARTS"

**Session ID:** Available via useBotPersistence hook (already used in WaterBot.jsx)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement RAG bridge — fetch enriched context on result nodes</name>
  <files>src/components/PermitFinder.jsx</files>
  <action>
Add RAG enrichment to result node rendering in PermitFinder:

**Props change:** Add `sessionId` prop to PermitFinder (passed from WaterBot.jsx where it's available from useBotPersistence).

**New state:**
- ragResponse (string | null) — the enriched context text
- ragSources (array | null) — source links from the response
- ragLoading (boolean) — loading indicator
- ragError (boolean) — error flag

**Trigger:** useEffect that fires when currentNodeId changes AND currentNode.type === 'result' AND currentNode.ragQuery exists:
- Set ragLoading=true, ragResponse=null, ragSources=null, ragError=false
- POST to `https://n8n.vanderdev.net/webhook/waterbot` with:
  - message: currentNode.ragQuery
  - sessionId: sessionId prop
  - messageHistory: [] (empty — this is a standalone enrichment query, not conversation)
- On success: set ragResponse=data.response, ragSources=data.sources || [], ragLoading=false
- On error: set ragError=true, ragLoading=false
- Use AbortController to cancel in-flight requests if user navigates away before response arrives (cleanup function in useEffect)

**Important:** Do NOT block ResultCard rendering on RAG response. ResultCards display immediately with static data. RAG enrichment loads asynchronously below them.

**Update WaterBot.jsx:** Pass sessionId to PermitFinder:
```
<PermitFinder
  onAskWaterBot={handleAskWaterBot}
  onBack={() => setMode('choice')}
  sessionId={sessionId}
/>
```
  </action>
  <verify>npm run build succeeds. Navigate to a result node — ResultCards appear immediately. After a brief delay, RAG response arrives (check Network tab for POST to webhook). Console shows no errors. Navigating back cancels any in-flight request (no state-update-on-unmounted warnings).</verify>
  <done>RAG query fires automatically on result nodes, response is stored in state, AbortController cleans up on navigation, ResultCards render without waiting for RAG.</done>
</task>

<task type="auto">
  <name>Task 2: Render enriched context section with loading and error states</name>
  <files>src/components/PermitFinder.jsx</files>
  <action>
Add the RAG enrichment display section below the ResultCards on result screens:

**Loading state (ragLoading === true):**
- Show a subtle loading indicator below ResultCards
- Style: flex row with Loader icon (spinning via animate-spin), text "Getting additional context from WaterBot..." in text-slate-400
- Positioned in a card-like container matching the dark theme

**Success state (ragResponse exists):**
- Render a styled card below ResultCards:
  - Background: bg-slate-800/50 with border border-slate-700 rounded-lg
  - Header: Droplets icon + "WaterBot Insights" in text-blue-400 font-medium
  - Body: ragResponse text rendered as paragraphs (split on double newlines)
  - Simple text rendering is fine — do NOT add a markdown parser dependency
  - If ragSources exists and has items, show a "Sources" section below:
    - Each source as a clickable link (text-blue-400 hover:underline)
    - External link icon next to each
    - Sources may be objects with url/title or plain strings — handle both

**Error state (ragError === true):**
- Show a subtle, non-blocking message: "Additional context unavailable" in text-slate-500 italic
- Do NOT show alarming error UI — the static ResultCard data is still fully useful

**No ragQuery state (currentNode.ragQuery is empty/missing):**
- Show nothing — no loading, no error, no enrichment section

**Layout order on result screen:**
1. Result header ("Your Permits" + context text)
2. ResultCard(s) — static permit data
3. RAG enrichment section (loading → success/error)
4. "Start New Search" button

Ensure the enrichment section doesn't push "Start New Search" off-screen on short viewports — use reasonable max-height or natural flow.
  </action>
  <verify>npm run build succeeds. Navigate to result — loading spinner appears briefly, then enriched context card shows with WaterBot response. Sources display as links if present. Navigate to a different result — previous response clears, new one loads. Error case: if webhook is down, subtle "unavailable" message shows without breaking the page.</verify>
  <done>RAG enrichment displays in styled card below ResultCards, loading state shows during fetch, error state is graceful, sources are clickable links, layout flows naturally without overflow.</done>
</task>

</tasks>

<verification>
Before declaring Phase 2 complete:
- [ ] `npm run build` succeeds without errors
- [ ] RAG query fires automatically on result nodes with ragQuery
- [ ] Loading indicator shows during fetch ("Getting additional context...")
- [ ] Enriched context displays in themed card with WaterBot Insights header
- [ ] Sources display as clickable links when present
- [ ] Error state is graceful (subtle "unavailable" text, not alarming)
- [ ] ResultCards display immediately (not blocked by RAG loading)
- [ ] Navigating back during RAG fetch cancels the request (no memory leak)
- [ ] Full end-to-end flow: landing → questions → result → enriched context → "Ask WaterBot" → chat
- [ ] No console errors or warnings throughout flow
- [ ] Chat mode still works correctly (no regression)
- [ ] Phase 2 complete — Permit Finder fully functional with RAG enrichment
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors or console warnings
- Permit Finder results are enriched with RAG context from knowledge base
- Loading and error states are handled gracefully
- Phase 2: Permit Finder is fully functional end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/02-permit-finder/02-03-SUMMARY.md` with:
- Note this completes Phase 2 (Permit Finder)
- Document the n8n webhook integration
- Note any issues with webhook response format
- Ready for Phase 3 (Funding Data Model)
</output>
