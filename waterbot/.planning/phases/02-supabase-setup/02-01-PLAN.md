---
phase: 02-supabase-setup
plan: 01
type: execute
subsystem: database
provides: [waterbot-schema, document-chunks-table, vector-index]
affects: [05-embedding-pipeline, 06-core-rag-chat]
---

<objective>
Create the WaterBot database schema and document_chunks table on VPS Supabase.

Purpose: Establish the vector database infrastructure required for RAG knowledge storage.
Output: `waterbot` schema with `document_chunks` table and IVFFlat vector index.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-scaffolding/01-01-SUMMARY.md

**Reference implementation:**
KiddoBot uses schema `kiddobot` in VPS supabase-db container (database `n8n`).
SSH: `ssh vps "docker exec supabase-db psql -U postgres -d n8n -c '<SQL>'"`

**Existing table schema (from kiddobot):**
```sql
Table "kiddobot.document_chunks"
   Column    |           Type           | Nullable |                Default
-------------+--------------------------+----------+------------------------------------------------------
 id          | integer                  | not null | nextval('kiddobot.document_chunks_id_seq'::regclass)
 document_id | text                     |          |
 chunk_text  | text                     | not null |
 chunk_index | integer                  |          | 0
 file_name   | text                     |          |
 file_path   | text                     |          |
 category    | text                     |          |
 subcategory | text                     |          |
 embedding   | vector(1536)             |          |
 created_at  | timestamp with time zone |          | now()

Index: ivfflat (embedding vector_cosine_ops) WITH (lists='35')
```

**Key constraints from PROJECT.md:**
- Embeddings: OpenAI text-embedding-3-small (1536 dimensions)
- Cosine similarity threshold > 0.70
- Top-K: 8 results
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create waterbot schema</name>
  <files>N/A (VPS database)</files>
  <action>
SSH to VPS and create the `waterbot` schema in the `n8n` database:

```bash
ssh vps "docker exec supabase-db psql -U postgres -d n8n -c 'CREATE SCHEMA IF NOT EXISTS waterbot;'"
```

Verify pgvector extension is already enabled (from kiddobot setup):
```bash
ssh vps "docker exec supabase-db psql -U postgres -d n8n -c 'SELECT extname FROM pg_extension WHERE extname = '\''vector'\'';'"
```

If not enabled: `CREATE EXTENSION IF NOT EXISTS vector;`
  </action>
  <verify>Schema exists: `ssh vps "docker exec supabase-db psql -U postgres -d n8n -c '\\dn waterbot'"` shows waterbot schema</verify>
  <done>Schema `waterbot` exists in database `n8n`</done>
</task>

<task type="auto">
  <name>Task 2: Create document_chunks table with vector index</name>
  <files>N/A (VPS database)</files>
  <action>
Create the document_chunks table matching KiddoBot structure:

```bash
ssh vps "docker exec supabase-db psql -U postgres -d n8n -c \"
CREATE TABLE IF NOT EXISTS waterbot.document_chunks (
    id SERIAL PRIMARY KEY,
    document_id TEXT,
    chunk_text TEXT NOT NULL,
    chunk_index INTEGER DEFAULT 0,
    file_name TEXT,
    file_path TEXT,
    category TEXT,
    subcategory TEXT,
    embedding vector(1536),
    created_at TIMESTAMPTZ DEFAULT now()
);
\""
```

Create the IVFFlat index for cosine similarity search:

```bash
ssh vps "docker exec supabase-db psql -U postgres -d n8n -c \"
CREATE INDEX IF NOT EXISTS idx_waterbot_chunks_embedding
ON waterbot.document_chunks
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 35);
\""
```

Note: `lists = 35` is a good starting point. Will be tuned in Phase 7 based on actual data volume.
  </action>
  <verify>Table exists with correct structure: `ssh vps "docker exec supabase-db psql -U postgres -d n8n -c '\\d waterbot.document_chunks'"` shows all columns and index</verify>
  <done>Table `waterbot.document_chunks` exists with id, document_id, chunk_text, chunk_index, file_name, file_path, category, subcategory, embedding (vector 1536), created_at; IVFFlat index on embedding column</done>
</task>

<task type="auto">
  <name>Task 3: Document connection info and verify</name>
  <files>src/config/supabase.js</files>
  <action>
Create a configuration file documenting the database connection for future n8n workflows:

```javascript
/**
 * Supabase Connection Info for WaterBot
 *
 * This file documents the database connection - actual connections
 * are made via n8n Postgres credentials, not from the frontend.
 *
 * Database: VPS supabase-db container
 * Host: db (docker network) or localhost:5432 (from VPS host)
 * Database: n8n
 * Schema: waterbot
 * Table: document_chunks
 *
 * n8n Credential: "Postgres account" (same as KiddoBot)
 * Connection: postgres://postgres:***@db:5432/n8n
 *
 * Table structure:
 * - id: serial primary key
 * - document_id: text (source document identifier)
 * - chunk_text: text (the actual content chunk)
 * - chunk_index: integer (position in source document)
 * - file_name: text (original file name)
 * - file_path: text (path in knowledge base)
 * - category: text (e.g., "permits", "funding")
 * - subcategory: text (e.g., "NPDES", "CWSRF")
 * - embedding: vector(1536) (OpenAI text-embedding-3-small)
 * - created_at: timestamptz
 *
 * Vector search parameters (from PROJECT.md):
 * - Cosine similarity threshold: > 0.70
 * - Top-K: 8 results
 * - Embedding model: text-embedding-3-small (1536 dimensions)
 */

export const WATERBOT_DB_CONFIG = {
  schema: 'waterbot',
  table: 'document_chunks',
  embeddingDimensions: 1536,
  similarityThreshold: 0.70,
  topK: 8,
}
```

Run a test query to verify the table is accessible:
```bash
ssh vps "docker exec supabase-db psql -U postgres -d n8n -c 'SELECT count(*) FROM waterbot.document_chunks;'"
```

Expected result: 0 rows (empty table, ready for Phase 5 embedding pipeline).
  </action>
  <verify>
    - Config file exists at src/config/supabase.js
    - Test query returns 0 (table accessible but empty)
    - `npm run build` still passes
  </verify>
  <done>Connection documented, table verified accessible, build passes</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `ssh vps "docker exec supabase-db psql -U postgres -d n8n -c '\\dn waterbot'"` shows schema
- [ ] `ssh vps "docker exec supabase-db psql -U postgres -d n8n -c '\\d waterbot.document_chunks'"` shows table with all columns
- [ ] Vector index visible in table description
- [ ] Test query `SELECT count(*)` succeeds with 0 rows
- [ ] `npm run build` passes
</verification>

<success_criteria>

- waterbot schema created in n8n database
- document_chunks table created with correct structure
- IVFFlat index created on embedding column
- Connection info documented in project
- Phase 2 complete, ready for Phase 3 (Knowledge Research: Permits)
</success_criteria>

<output>
After completion, create `.planning/phases/02-supabase-setup/02-01-SUMMARY.md` using summary.md template.
</output>
