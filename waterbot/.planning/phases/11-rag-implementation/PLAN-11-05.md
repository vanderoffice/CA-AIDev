# PLAN-11-05: Integration Testing

## Objective
End-to-end testing of the RAG pipeline from user query to response.

## Prerequisites
- All PLAN-11-01 through PLAN-11-04 complete
- Webhook endpoint live
- Knowledge base embedded

## Test Categories

### 1. Retrieval Quality Tests

Test that vector search returns relevant content:

| Query | Expected Category | Expected Topics |
|-------|-------------------|-----------------|
| "What is an NPDES permit?" | permits | NPDES overview, application process |
| "How do I report a water violation?" | compliance | Reporting requirements, enforcement |
| "What funding is available for small communities?" | funding | CWSRF, DWSRF, disadvantaged communities |
| "What are basin plans?" | water-quality | Basin plan overview, beneficial uses |
| "Who is my Regional Board?" | entities | Regional board map, contacts |
| "What are appropriative water rights?" | water-rights | Appropriative rights overview |
| "What happens during a drought?" | climate-drought | Drought regulations, conservation |
| "How do I access CIWQS?" | public-resources | CIWQS overview, data access |

### 2. Response Quality Tests

Evaluate LLM responses for:
- **Accuracy**: Does the response match the knowledge base?
- **Groundedness**: Are claims supported by retrieved context?
- **Completeness**: Does it address the user's question fully?
- **Helpfulness**: Does it provide actionable next steps?

### 3. Edge Case Tests

| Scenario | Expected Behavior |
|----------|-------------------|
| Off-topic query ("What's the weather?") | Polite redirect to water topics |
| Ambiguous query ("permits") | Ask for clarification or provide overview |
| Multiple topics ("permits and funding") | Address both or suggest splitting |
| No relevant context found | Acknowledge gap, suggest official contact |
| Very long query (>500 chars) | Handle gracefully, extract key intent |

### 4. Performance Tests

| Metric | Target | Method |
|--------|--------|--------|
| Webhook response time | < 5s | curl timing |
| Vector search latency | < 500ms | Postgres EXPLAIN ANALYZE |
| Concurrent requests | 5 simultaneous | Load test |

### 5. Frontend Integration Test

Using WaterBot.jsx:
1. Submit test query
2. Verify loading state appears
3. Verify response displays correctly
4. Check markdown rendering (links, bold, lists)
5. Test conversation continuity (follow-up questions)

## Test Execution

### Manual Test Script
```bash
# Test webhook directly
curl -X POST https://n8n.vanderdev.net/webhook/waterbot \
  -H "Content-Type: application/json" \
  -d '{
    "message": "What is an NPDES permit?",
    "sessionId": "test-123",
    "messageHistory": []
  }'
```

### Automated Test Suite (Optional)
If time permits, create `scripts/test-rag.js`:
- Run all test queries
- Log responses
- Calculate success rate

## Output
- Test results documentation
- Performance metrics
- Issue list for any failures
- Tuning recommendations

## Success Criteria
- [ ] 8/8 category retrieval tests pass
- [ ] Response quality rated "good" on 80%+ of test queries
- [ ] All edge cases handled gracefully
- [ ] Performance targets met
- [ ] Frontend integration working

## Post-Testing Actions
- Document any parameter tuning applied
- Note areas for future improvement
- Update RESUME.md with Phase 11 completion status
