# PLAN-11-03: Vector Search & Retrieval Functions

## Objective
Create retrieval functions for semantic search over the knowledge base.

## Prerequisites
- `waterbot.document_chunks` populated with embeddings (PLAN-11-02)
- Working n8n Postgres credential

## Architecture Decision: Postgres Function vs n8n Logic

**Chosen: Hybrid Approach**
1. **Postgres function** for efficient vector search with threshold/limit
2. **n8n workflow** for orchestration and result formatting

Rationale: Postgres pgvector operators are fastest; n8n handles the API glue.

## Tasks

### 1. Create Postgres Search Function

```sql
-- Match documents by embedding similarity
CREATE OR REPLACE FUNCTION waterbot.match_documents(
  query_embedding vector(1536),
  match_threshold float DEFAULT 0.70,
  match_count int DEFAULT 8,
  filter_category text DEFAULT NULL
)
RETURNS TABLE (
  id integer,
  chunk_text text,
  category text,
  subcategory text,
  file_name text,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    dc.id,
    dc.chunk_text,
    dc.category,
    dc.subcategory,
    dc.file_name,
    1 - (dc.embedding <=> query_embedding) AS similarity
  FROM waterbot.document_chunks dc
  WHERE 
    (filter_category IS NULL OR dc.category = filter_category)
    AND 1 - (dc.embedding <=> query_embedding) > match_threshold
  ORDER BY dc.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

### 2. Create n8n Retrieval Sub-workflow

Workflow: "WaterBot - Retrieve Context"

**Purpose:** Reusable sub-workflow called by chat workflow

**Input:**
- `query`: User's question text
- `category`: Optional filter (permits, funding, compliance, etc.)
- `threshold`: Similarity threshold (default 0.70)
- `limit`: Max results (default 8)

**Nodes:**
1. **Webhook** - Receives query from parent workflow
2. **OpenAI Embeddings** - Generate query embedding
3. **Postgres** - Call `waterbot.match_documents()` function
4. **Format Results** - Structure context for LLM consumption
5. **Respond to Webhook** - Return context array

**Output Format:**
```json
{
  "context": [
    {
      "text": "## NPDES Permits\n\nThe National Pollutant...",
      "source": "permits/npdes/npdes-overview.md",
      "relevance": 0.87
    }
  ],
  "metadata": {
    "query": "What is an NPDES permit?",
    "matches_found": 5,
    "threshold_used": 0.70
  }
}
```

### 3. Test Retrieval Quality

Test queries across knowledge domains:
1. "How do I apply for an NPDES permit?" → should return permit content
2. "What funding is available for wastewater treatment?" → should return funding content
3. "What is a TMDL?" → should return water quality content
4. "Who enforces water rights?" → should return entities content

### 4. Tune Parameters

If results are poor:
- Lower threshold to 0.65 for broader matches
- Increase limit to 10-12 for more context
- Add category filtering for focused searches

## Output
- Postgres function: `waterbot.match_documents()`
- n8n workflow: "WaterBot - Retrieve Context"
- Test results documentation

## Success Criteria
- [ ] Search returns relevant chunks for test queries
- [ ] Response time < 500ms for typical queries
- [ ] Category filtering works correctly
- [ ] No SQL injection vulnerabilities
