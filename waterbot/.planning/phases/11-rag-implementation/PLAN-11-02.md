# PLAN-11-02: Embedding Generation Pipeline

## Objective
Generate embeddings for all knowledge chunks using OpenAI text-embedding-3-small and load into Supabase.

## Prerequisites
- `scripts/chunks.json` from PLAN-11-01
- OpenAI API access (via n8n or direct)
- `waterbot.document_chunks` table ready

## Architecture Decision: n8n vs Script

**Chosen: n8n Workflow**

Rationale:
1. Existing OpenAI credential configured in n8n
2. Built-in rate limiting and retry logic
3. Visual debugging for failures
4. Reusable for future re-indexing
5. Matches KiddoBot pattern

## Tasks

### 1. Create n8n Embedding Workflow

Workflow: "WaterBot - Embed Knowledge"

**Nodes:**
1. **Manual Trigger** - Start with button click
2. **Read File** - Load chunks.json from local path or GitHub
3. **Split in Batches** - Process 20 chunks at a time (OpenAI batch limit)
4. **OpenAI Embeddings** - Generate embeddings (text-embedding-3-small)
5. **Postgres Insert** - Write to waterbot.document_chunks
6. **Summary** - Log total processed

### 2. Database Schema Reminder
```sql
-- Already exists from Phase 2
INSERT INTO waterbot.document_chunks (
  document_id,
  chunk_text,
  chunk_index,
  file_name,
  file_path,
  category,
  subcategory,
  embedding
) VALUES (
  $1, $2, $3, $4, $5, $6, $7, $8::vector
);
```

### 3. Cost Estimation
- Estimated chunks: ~400-600 (depends on chunking strategy)
- text-embedding-3-small: $0.02/1M tokens
- Estimated tokens: ~500k (avg 1000 tokens/chunk Ã— 500 chunks)
- **Estimated cost: ~$0.01** (negligible)

### 4. Verify Embeddings
```sql
-- Verify load
SELECT 
  category,
  COUNT(*) as chunk_count,
  AVG(LENGTH(chunk_text)) as avg_length
FROM waterbot.document_chunks
GROUP BY category
ORDER BY category;

-- Test vector retrieval
SELECT chunk_text, 1 - (embedding <=> $test_vector) as similarity
FROM waterbot.document_chunks
ORDER BY embedding <=> $test_vector
LIMIT 5;
```

## Output
- n8n workflow: "WaterBot - Embed Knowledge"
- `waterbot.document_chunks` populated with embeddings
- Verification query results

## Success Criteria
- [ ] All chunks have valid 1536-dimension embeddings
- [ ] No null embeddings in database
- [ ] Test vector search returns relevant results
- [ ] Chunk counts match expected (~400-600)

## Rollback
```sql
-- Clear and retry if needed
TRUNCATE waterbot.document_chunks;
```
