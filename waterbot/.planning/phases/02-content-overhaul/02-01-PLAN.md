---
phase: 02-content-overhaul
plan: 01
type: execute
---

<objective>
Rewrite consumer FAQ, permits & compliance, and pollutants content with inline URLs from the registry and "Take Action" sections — establishing the rewrite pattern used by all subsequent plans.

Purpose: These are the most user-facing topics (consumer questions, permit guidance, contaminant info). Enhancing them first delivers the highest-impact improvements and establishes the rewrite methodology for Plans 02-04.
Output: 8 updated JSON files (3 batch + 5 individual) with inline URLs, fact-checked content, and "Take Action" sections.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 summaries (registry creation context):
@.planning/phases/01-url-registry/01-01-SUMMARY.md
@.planning/phases/01-url-registry/01-04-SUMMARY.md

# URL registry (source of truth for all URLs):
@rag-content/waterbot/url_registry.json

# Files to rewrite (batch — currently NO inline URLs):
@rag-content/waterbot/batch_consumer_faq.json
@rag-content/waterbot/batch_permits_compliance.json
@rag-content/waterbot/batch_pollutants.json

# Files to update (individual — already have URLs, need verification + "Take Action"):
@rag-content/waterbot/401_certification_fees.json
@rag-content/waterbot/npdes_application_guide.json
@rag-content/waterbot/npdes_permit_fees.json
@rag-content/waterbot/stormwater_permit_fees.json
@rag-content/waterbot/water_quality_testing.json

**Tech stack available:** Python 3 for JSON manipulation, jq for validation
**Established patterns:** JSON registry schema v1.0, batch JSON format with {content, metadata} per doc
**Constraining decisions:**
- Phase 01-01: URL registry has 179 topics with 577 URLs (3.2 avg/topic)
- Phase 01-04: 98.6% of registry URLs validated working; 403s are OK (bot protection)
- PROJECT.md: Prefer stable parent pages over deep links (CA gov restructures frequently)
- PROJECT.md: Inline URLs in content (not just metadata) — embeddings include URL text so LLM sees links in retrieved context

**Content Rewrite Specification (used by all Phase 2 plans):**

1. **Inline URLs**: Embed registry URLs as markdown hyperlinks at natural citation points
   - Referencing a program: "...the [SAFER Program](https://...)"
   - Citing a regulation: "...under [Clean Water Act Section 401](https://...)"
   - Mentioning a database: "...in the [CIWQS database](https://...)"
   - Use the registry `label` field for link text, or write natural link text that fits the sentence
   - Every doc should have 2-5 inline URL references woven into existing content

2. **"Take Action" section**: Add `## Take Action` at the end of each document
   - 3-5 numbered steps with action verbs
   - Each step links to a relevant URL from the registry
   - URL `type` field guides the step:
     * `portal`/`form` → "Apply at..." / "Submit via..."
     * `database`/`tool` → "Look up..." / "Search..."
     * `contact` → "Contact your..."
     * `info`/`regulation` → "Learn more at..." / "Review..."
   - Steps should be specific to the topic, not generic

3. **Fact verification**: Check specific numbers, dates, fees, thresholds in content
   - Fee amounts, program deadlines, and regulatory thresholds are most likely to be outdated
   - If a figure can't be verified, note it with "[verify current amount]" rather than guessing

4. **Preserve what works**: Keep existing structure and good content. Enhance, don't rewrite from scratch.
   - Keep headings, section structure, bullet lists
   - Add URLs to existing text, don't restructure around them
   - Keep metadata (topic, category, subcategory) unchanged

5. **JSON integrity**: Each doc remains `{content: "...", metadata: {...}}`. Content is a markdown string.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite 3 batch files — consumer FAQ, permits & compliance, pollutants (32 docs)</name>
  <files>rag-content/waterbot/batch_consumer_faq.json, rag-content/waterbot/batch_permits_compliance.json, rag-content/waterbot/batch_pollutants.json</files>
  <action>
  Use Python to process each batch file:

  1. Load `url_registry.json` and build a topic→URLs lookup dict
  2. For each batch file, load the JSON array of documents
  3. For each document:
     a. Match `metadata.topic` to registry entry (exact match on topic name)
     b. Get the 2-5 URLs for that topic from registry
     c. Enhance the `content` field:
        - Weave inline markdown links at natural citation points throughout existing content
        - Add a `## Take Action` section at the end with 3-5 numbered steps
        - Each step uses an action verb + links to a registry URL
     d. Fact-check any specific figures (MCLs, fee amounts, deadlines) — if a number looks outdated, flag with "[verify]"
     e. Keep metadata unchanged
  4. Write updated JSON back to the same file path

  **Processing order:** batch_consumer_faq.json first (12 docs, highest user impact), then batch_permits_compliance.json (10 docs), then batch_pollutants.json (10 docs).

  **For consumer FAQ topics** (e.g., "Hard Water Health and Safety", "Tap Water vs Bottled Water"):
  - Inline links should reference DDW, EPA, and SWRCB informational pages
  - "Take Action" should guide residents to test water, find their utility, file complaints

  **For permits & compliance topics** (e.g., "NPDES Permit Overview", "Monitoring and Reporting"):
  - Inline links should reference SWRCB permit portals, fee schedules, forms
  - "Take Action" should guide applicants to apply, check fees, contact regional board

  **For pollutant topics** (e.g., "Lead in Drinking Water", "PFAS Contamination"):
  - Inline links should reference DDW MCL pages, EPA contaminant info, OEHHA PHGs
  - "Take Action" should guide residents to test water, check local reports, report contamination
  </action>
  <verify>
  Run Python verification:
  ```python
  import json
  for f in ['batch_consumer_faq.json', 'batch_permits_compliance.json', 'batch_pollutants.json']:
      data = json.load(open(f'rag-content/waterbot/{f}'))
      docs = data if isinstance(data, list) else data.get('documents', [])
      for d in docs:
          content = d['content']
          assert 'http' in content, f"Missing URLs in {d['metadata']['topic']}"
          assert '## Take Action' in content, f"Missing Take Action in {d['metadata']['topic']}"
          assert d['metadata']['topic'], "Missing topic metadata"
      print(f'{f}: {len(docs)} docs verified')
  ```
  </verify>
  <done>All 32 docs across 3 batch files contain inline URLs and "Take Action" sections. Metadata unchanged. JSON valid.</done>
</task>

<task type="auto">
  <name>Task 2: Update 5 individual files and verify all 8 files</name>
  <files>rag-content/waterbot/401_certification_fees.json, rag-content/waterbot/npdes_application_guide.json, rag-content/waterbot/npdes_permit_fees.json, rag-content/waterbot/stormwater_permit_fees.json, rag-content/waterbot/water_quality_testing.json</files>
  <action>
  These 5 individual files already contain URLs from Phase 1 rich content work. For each:

  1. Load the file and compare its content URLs against the registry entry for that topic
  2. If registry has URLs not present in content, add them as inline links or in "Take Action"
  3. Add `## Take Action` section if not already present (most individual files won't have one)
  4. Fact-check specific figures (fee amounts for 401/NPDES/stormwater, testing procedures for water_quality_testing)
  5. Ensure inline link format matches the pattern from Task 1 (markdown links, not bare URLs)
     - If content has bare URLs like `https://...`, convert to `[Label](https://...)` using registry labels
  6. Write updated JSON back

  After updating individual files, run a comprehensive verification across ALL 8 files in this plan:
  - Every doc has ≥2 inline URLs (markdown link format)
  - Every doc has a "## Take Action" section
  - Every URL in content exists in the registry (no stale/invented URLs)
  - JSON structure valid for all files
  - Total: 37 topics across 8 files verified
  </action>
  <verify>
  Run comprehensive Python check across all 8 files:
  ```python
  import json, re
  files = [
      'batch_consumer_faq.json', 'batch_permits_compliance.json', 'batch_pollutants.json',
      '401_certification_fees.json', 'npdes_application_guide.json', 'npdes_permit_fees.json',
      'stormwater_permit_fees.json', 'water_quality_testing.json'
  ]
  total = 0
  for f in files:
      data = json.load(open(f'rag-content/waterbot/{f}'))
      docs = data if isinstance(data, list) else data.get('documents', [])
      for d in docs:
          c = d['content']
          links = re.findall(r'\[([^\]]+)\]\(https?://[^)]+\)', c)
          assert len(links) >= 2, f"Only {len(links)} links in {d['metadata']['topic']}"
          assert '## Take Action' in c, f"Missing Take Action in {d['metadata']['topic']}"
          total += 1
  print(f'All {total} topics verified with inline URLs and Take Action sections')
  ```
  </verify>
  <done>All 37 topics across 8 files have ≥2 inline markdown URLs and "Take Action" sections. No bare URLs remain. JSON valid.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 batch files rewritten with inline URLs and "Take Action" sections
- [ ] All 5 individual files updated with consistent URL format and "Take Action" sections
- [ ] Every doc has ≥2 inline markdown links (not bare URLs)
- [ ] Every doc has a "## Take Action" section with 3-5 linked steps
- [ ] Metadata (topic, category, subcategory) unchanged in all files
- [ ] JSON valid for all 8 files (parseable, correct structure)
- [ ] No invented URLs — all links sourced from url_registry.json
</verification>

<success_criteria>

- All 37 topics enhanced with inline URLs and "Take Action" sections
- URL format consistent: `[Label](https://...)` throughout
- Content quality maintained or improved
- All verification checks pass
- Rewrite pattern established for Plans 02-02 through 02-04
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-overhaul/02-01-SUMMARY.md`
</output>
