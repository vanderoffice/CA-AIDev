---
phase: 01-url-registry
plan: 04
type: execute
---

<objective>
Validate every URL in the registry (HTTP 200 check), fix broken/redirected links, fill any remaining gaps, and finalize the registry as the single source of truth for WaterBot link maintenance.

Purpose: Ensure every URL in the registry actually works before Phase 2 uses them to rewrite content. A registry full of broken links is worse than no registry.
Output: Validated `url_registry.json` with 100% working URLs. Validation report documenting results.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/phase-prompt.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-url-registry/01-01-SUMMARY.md
@.planning/phases/01-url-registry/01-02-SUMMARY.md
@.planning/phases/01-url-registry/01-03-SUMMARY.md

**Complete registry:**
@rag-content/waterbot/url_registry.json

**Existing validation infrastructure:**
@scripts/test_all_urls.py
@scripts/test_urls_from_files.py

**Key constraint:**
- CA gov sites restructure frequently (learned from Jan 2026 audit that fixed 116 broken URLs)
- Some sites block automated requests — may need User-Agent header and retry logic
- Redirects (3xx) should be followed and the final URL recorded
- waterboards.ca.gov uses both www and non-www — normalize to consistent form
</context>

<tasks>

<task type="auto">
  <name>Task 1: Validate all registry URLs and generate report</name>
  <files>rag-content/waterbot/url_registry.json, scripts/validate_registry_urls.py</files>
  <action>
  Create a validation script `scripts/validate_registry_urls.py` that:

  1. Reads url_registry.json
  2. Extracts all unique URLs across all entries
  3. Tests each URL with HTTP HEAD/GET request (timeout 10s, follow redirects, proper User-Agent)
  4. Categorizes results: OK (200), Redirect (3xx — note final URL), Client Error (4xx), Server Error (5xx), DNS Failure, Timeout
  5. For redirects: record the final destination URL
  6. Runs checks in parallel (ThreadPoolExecutor, max 20 workers) for speed
  7. Outputs:
     - Console summary (counts per category)
     - Detailed report of non-200 URLs with error details
     - List of topics with broken URLs
     - JSON results to `url_registry_validation.json`

  Pattern after existing `scripts/test_all_urls.py` but adapted for registry format instead of database extraction.

  Run the script. Analyze results:
  - If >90% OK: proceed to Task 2 for fixes
  - If <90% OK: investigate whether there's a systematic issue (blocked requests, stale domain patterns)

  Add validation results to the registry by adding a `validation` top-level object:
  ```
  "validation": {
    "last_run": "2026-02-XX",
    "total_urls": N,
    "ok": N,
    "redirected": N,
    "broken": N,
    "timeout": N
  }
  ```
  </action>
  <verify>
  - `scripts/validate_registry_urls.py` runs without errors
  - `url_registry_validation.json` created with detailed results
  - Validation summary in registry JSON
  - Console output shows clear categorization
  </verify>
  <done>All registry URLs tested. Validation report generated. Results categorized and quantified. Broken URLs identified for fixing in Task 2.</done>
</task>

<task type="auto">
  <name>Task 2: Fix broken URLs, resolve redirects, finalize registry</name>
  <files>rag-content/waterbot/url_registry.json</files>
  <action>
  Using the validation report from Task 1:

  **For broken URLs (4xx, 5xx, DNS failures):**
  1. Research replacement URLs via WebSearch — find the current correct page for each topic
  2. Update the URL entry in the registry
  3. If a replacement can't be found, remove the URL entry and add a note
  4. If a topic drops below 2 URLs after removals, research additional URLs to meet the minimum

  **For redirected URLs (3xx):**
  1. If redirect is to a stable final URL on the same domain, update the URL to the final destination
  2. If redirect is to a different domain, investigate and verify the new location is correct
  3. Update the stable flag based on redirect behavior

  **Quality checks:**
  1. Verify no duplicate URLs within any single topic entry
  2. Verify no topic has more than 5 or fewer than 2 URLs
  3. Normalize all URLs: consistent www vs non-www, trailing slashes, HTTPS
  4. Remove any mailto: or tel: links that shouldn't be in the registry

  **Finalize:**
  1. Update stats section with final counts
  2. Update validation section with post-fix results
  3. Re-run validation script to confirm all fixes applied
  4. Generate final summary: total topics, total URLs, URLs per topic distribution, category coverage

  The registry is now the single source of truth for WaterBot URLs. Phase 1 complete.
  </action>
  <verify>
  - Re-run `python3 scripts/validate_registry_urls.py` shows 0 broken URLs (or only known-false-positives documented)
  - Every topic has 2-5 URLs: `python3 -c "import json; d=json.load(open('rag-content/waterbot/url_registry.json')); bad=[e['topic'] for e in d['entries'] if len(e['urls'])<2 or len(e['urls'])>5]; print(f'Out of range: {len(bad)}'); print(bad[:5] if bad else 'None')"`
  - No duplicate URLs within any topic
  - Stats and validation sections accurate
  - JSON is valid
  </verify>
  <done>All broken URLs fixed or replaced. All redirects resolved. Every topic has 2-5 working URLs. Registry finalized as single source of truth. Phase 1 complete.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `validate_registry_urls.py` passes with 0 broken URLs (or documented false positives only)
- [ ] All 179 topics have 2-5 URLs each
- [ ] No duplicate URLs within topics
- [ ] URLs normalized (HTTPS, consistent www usage)
- [ ] Stats and validation sections accurate
- [ ] Registry is valid JSON
- [ ] `url_registry_validation.json` exists with detailed results
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- 0 broken URLs in registry (or documented exceptions)
- Every topic: 2-5 working, actionable URLs
- Validation script created for ongoing maintenance
- Registry ready to serve as URL source for Phase 2 content rewriting
- Phase 1: URL Registry & Validation — COMPLETE
</success_criteria>

<output>
After completion, create `.planning/phases/01-url-registry/01-04-SUMMARY.md`:

# Phase 1 Plan 4: URL Validation & Finalization Summary

**[One-liner about what shipped]**

## Accomplishments
- [validation results]
- [broken URLs fixed]
- [registry finalized]

## Files Created/Modified
- `scripts/validate_registry_urls.py` - URL validation script for registry
- `rag-content/waterbot/url_registry.json` - Finalized with all fixes
- `url_registry_validation.json` - Detailed validation results

## Registry Statistics
- Total topics: 179
- Total URLs: [N]
- Avg URLs/topic: [N]
- Validation: [N]/[N] OK (100%)

## Decisions Made
[Any decisions about URL handling]

## Issues Encountered
[Problems and resolutions]

## Next Phase Readiness
Phase 2 (Content Overhaul) can begin — URL registry is ready as the link source for content rewriting.
</output>
