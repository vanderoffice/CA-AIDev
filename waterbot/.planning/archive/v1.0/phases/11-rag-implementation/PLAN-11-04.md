# PLAN-11-04: n8n Chat Workflow

## Objective
Create the main WaterBot chat workflow that handles user queries via RAG.

## Prerequisites
- "WaterBot - Retrieve Context" workflow from PLAN-11-03
- Embedded knowledge base ready
- OpenAI API access for chat completion

## Architecture

```
User Question
     ↓
[Webhook: /waterbot]
     ↓
[Retrieve Context] ← calls PLAN-11-03 workflow
     ↓
[Build Prompt] ← system prompt + context + user question
     ↓
[OpenAI Chat] ← GPT-4o or Claude for response
     ↓
[Format Response]
     ↓
[Return to Frontend]
```

## Tasks

### 1. Create Main Chat Workflow

Workflow: "WaterBot - Chat"

**Nodes:**

1. **Webhook** 
   - Path: `/waterbot`
   - Method: POST
   - Response Mode: Last Node

2. **Extract Input**
   - Parse: message, sessionId, messageHistory, userContext

3. **Retrieve Context** (Execute Workflow node)
   - Call "WaterBot - Retrieve Context"
   - Pass: query = message, limit = 8

4. **Build Prompt**
   - System prompt (see below)
   - Context from retrieval
   - Conversation history
   - Current question

5. **OpenAI Chat Completion**
   - Model: gpt-4o (or claude-3-5-sonnet via LLM Gateway)
   - Temperature: 0.3 (factual responses)
   - Max tokens: 1000

6. **Format Response**
   - Extract assistant message
   - Include source references if relevant

7. **Respond to Webhook**
   - Return: { response: "...", sources: [...] }

### 2. System Prompt

```
You are WaterBot, an expert assistant for California Water Boards regulations, permits, and programs.

ROLE:
- Help users understand water quality regulations, permits, and compliance
- Explain funding opportunities for water infrastructure
- Guide users to the right resources and contacts

GUIDELINES:
- Use ONLY the provided context to answer questions
- If the context doesn't contain the answer, say so and suggest contacting the appropriate Regional Water Board
- Be specific about permit types, deadlines, and requirements
- Include relevant links and contact information when available
- Never make up regulations or requirements

CONTEXT FROM KNOWLEDGE BASE:
{context}

CONVERSATION HISTORY:
{history}

USER QUESTION:
{question}

Provide a helpful, accurate response based on the context above.
```

### 3. Error Handling

- No context found → "I don't have specific information about that topic. For official guidance, please contact your Regional Water Quality Control Board."
- API timeout → "I'm having trouble right now. Please try again in a moment."
- Rate limit → Queue and retry with exponential backoff

### 4. Webhook Configuration

Register with n8n:
- URL: `https://n8n.vanderdev.net/webhook/waterbot`
- Auth: None (public endpoint, but session-scoped)
- CORS: Allow vanderdev.net origins

## Output
- n8n workflow: "WaterBot - Chat"
- Webhook endpoint live at `/waterbot`
- System prompt documented

## Success Criteria
- [ ] Webhook responds to POST requests
- [ ] Context retrieval integrated correctly
- [ ] Responses are grounded in knowledge base
- [ ] Graceful error handling for edge cases
- [ ] Response time < 5s for typical queries
