{
  "name": "WiseBot - Operations Dashboard",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 6
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule (Every 6 Hours)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "content": "## WiseBot Operations Dashboard\n\n**Purpose:** Monitor system health, track failures, and send periodic operational reports.\n\n**Schedule:** Every 6 hours (configurable)\n\n**Checks Performed:**\n1. Database connectivity\n2. Failed executions in last period\n3. Document processing stats\n4. Storage usage metrics\n5. Duplicate detection stats\n\n**Output:**\n- Health check records in ops_health_checks table\n- Email summary to operations team\n\n**Configuration:**\n- `WISEBOT_OPS_EMAIL` - Alert recipient\n- `WISEBOT_OPS_INTERVAL` - Check interval",
        "height": 440,
        "width": 400
      },
      "id": "sticky-intro",
      "name": "Sticky Note - Introduction",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [40, 20]
    },
    {
      "parameters": {
        "jsCode": "// Initialize health check run\nconst checkId = `chk_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\nconst startTime = new Date();\n\nreturn [{\n  json: {\n    checkId,\n    startTime: startTime.toISOString(),\n    checksToRun: [\n      'db_connectivity',\n      'failed_executions',\n      'processing_stats',\n      'storage_metrics',\n      'duplicate_stats'\n    ],\n    results: {}\n  }\n}];"
      },
      "id": "init-check",
      "name": "Initialize Health Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "wisebot_config",
        "filters": {
          "filter": [
            {
              "column": "key",
              "value": "ops_email"
            }
          ]
        },
        "options": {
          "limit": 1
        }
      },
      "id": "check-db-connectivity",
      "name": "Check DB Connectivity",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [680, 200],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "content": "## Health Checks\n\nAll checks run in parallel for efficiency.\n\n**DB Connectivity:**\n- Simple SELECT query\n- Measures response time\n\n**Failed Executions:**\n- Queries ingestion_logs\n- Last 6 hours by default\n\n**Processing Stats:**\n- Documents processed\n- By status and type",
        "height": 220,
        "width": 260
      },
      "id": "sticky-checks",
      "name": "Sticky Note - Checks",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [680, 20]
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "ingestion_logs",
        "filters": {
          "filter": [
            {
              "column": "success",
              "value": "false"
            },
            {
              "column": "started_at",
              "operator": "gte",
              "value": "={{$now.minus({hours: 6}).toISO()}}"
            }
          ]
        },
        "options": {
          "limit": 100
        }
      },
      "id": "get-failed-executions",
      "name": "Get Failed Executions",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [680, 400],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.SUPABASE_URL}}/rest/v1/rpc/get_processing_stats",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{}",
        "options": {}
      },
      "id": "get-processing-stats",
      "name": "Get Processing Stats",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [680, 600],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "documents",
        "options": {
          "count": "exact"
        }
      },
      "id": "count-documents",
      "name": "Count Total Documents",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [680, 800],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "document_chunks",
        "options": {
          "count": "exact"
        }
      },
      "id": "count-chunks",
      "name": "Count Total Chunks",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [680, 1000],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "duplicate_detections",
        "filters": {
          "filter": [
            {
              "column": "detected_at",
              "operator": "gte",
              "value": "={{$now.minus({hours: 6}).toISO()}}"
            }
          ]
        },
        "options": {}
      },
      "id": "get-recent-duplicates",
      "name": "Get Recent Duplicates",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [680, 1200],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Aggregate all health check results\nconst initData = $('Initialize Health Check').first().json;\nconst dbResult = $('Check DB Connectivity').first();\nconst failedExecs = $('Get Failed Executions').all();\nconst docCount = $('Count Total Documents').first();\nconst chunkCount = $('Count Total Chunks').first();\nconst recentDups = $('Get Recent Duplicates').all();\n\n// Calculate response times and status\nconst now = new Date();\nconst startTime = new Date(initData.startTime);\nconst totalDuration = now - startTime;\n\n// DB connectivity check\nconst dbHealthy = !dbResult.error && dbResult.json;\nconst dbStatus = dbHealthy ? 'healthy' : 'unhealthy';\n\n// Failed executions check\nconst failedCount = failedExecs.length;\nconst failedStatus = failedCount === 0 ? 'healthy' : \n                     failedCount < 5 ? 'degraded' : 'unhealthy';\n\n// Document stats\nconst totalDocs = docCount.json?.count || 0;\nconst totalChunks = chunkCount.json?.count || 0;\n\n// Recent duplicates\nconst exactDups = recentDups.filter(d => d.json?.detection_type === 'exact_duplicate').length;\nconst fuzzyDups = recentDups.filter(d => d.json?.detection_type === 'fuzzy_duplicate').length;\n\n// Overall health status\nlet overallStatus = 'healthy';\nif (!dbHealthy) overallStatus = 'unhealthy';\nelse if (failedCount >= 5) overallStatus = 'unhealthy';\nelse if (failedCount > 0) overallStatus = 'degraded';\n\n// Build summary\nconst summary = {\n  checkId: initData.checkId,\n  timestamp: now.toISOString(),\n  durationMs: totalDuration,\n  overallStatus,\n  checks: {\n    database: {\n      status: dbStatus,\n      message: dbHealthy ? 'Connection successful' : 'Connection failed'\n    },\n    failedExecutions: {\n      status: failedStatus,\n      count: failedCount,\n      details: failedExecs.slice(0, 10).map(f => ({\n        file: f.json?.file_name,\n        error: f.json?.error_message,\n        time: f.json?.started_at\n      }))\n    },\n    storage: {\n      totalDocuments: totalDocs,\n      totalChunks: totalChunks,\n      avgChunksPerDoc: totalDocs > 0 ? (totalChunks / totalDocs).toFixed(1) : 0\n    },\n    duplicates: {\n      recentExact: exactDups,\n      recentFuzzy: fuzzyDups,\n      total: exactDups + fuzzyDups\n    }\n  }\n};\n\nreturn [{ json: summary }];"
      },
      "id": "aggregate-results",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 600]
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "ops_health_checks",
        "columns": "check_type,check_name,status,response_time_ms,details",
        "values": "='periodic','system_health',='{{$json.overallStatus}}',={{$json.durationMs}},='{{JSON.stringify($json.checks)}}'",
        "options": {}
      },
      "id": "store-health-check",
      "name": "Store Health Check",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1220, 500],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-unhealthy",
              "leftValue": "={{$json.overallStatus}}",
              "rightValue": "unhealthy",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-critical",
      "name": "Critical Issues?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1220, 700]
    },
    {
      "parameters": {
        "sendTo": "={{$env.WISEBOT_OPS_EMAIL || 'ops@example.com'}}",
        "subject": "ðŸš¨ WiseBot CRITICAL: System Health Alert",
        "message": "**CRITICAL ALERT: WiseBot System Health Issue Detected**\n\n**Check ID:** {{$json.checkId}}\n**Timestamp:** {{$json.timestamp}}\n**Overall Status:** {{$json.overallStatus.toUpperCase()}}\n\n---\n\n**Database Status:** {{$json.checks.database.status}}\n- {{$json.checks.database.message}}\n\n**Failed Executions:** {{$json.checks.failedExecutions.count}} in last 6 hours\n{{$json.checks.failedExecutions.count > 0 ? '\\nRecent failures:\\n' + $json.checks.failedExecutions.details.map(d => '- ' + d.file + ': ' + d.error).join('\\n') : ''}}\n\n**Storage Metrics:**\n- Total Documents: {{$json.checks.storage.totalDocuments}}\n- Total Chunks: {{$json.checks.storage.totalChunks}}\n\n**Duplicate Detections (Last 6h):**\n- Exact: {{$json.checks.duplicates.recentExact}}\n- Fuzzy: {{$json.checks.duplicates.recentFuzzy}}\n\n---\n\n**Action Required:** Please investigate the critical issues immediately.\n\nCheck the n8n execution logs and Supabase ingestion_logs table for details.",
        "options": {}
      },
      "id": "send-critical-alert",
      "name": "Send Critical Alert",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1440, 600],
      "credentials": {
        "gmailOAuth2": {
          "id": "GMAIL_CREDENTIAL_ID",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {
        "content": "## Alert Routing\n\n**Critical (Unhealthy):**\n- Immediate email alert\n- Subject: ðŸš¨ CRITICAL\n\n**Degraded:**\n- Included in periodic summary\n- No immediate alert\n\n**Healthy:**\n- Logged only\n- Summary on schedule",
        "height": 200,
        "width": 260
      },
      "id": "sticky-alerts",
      "name": "Sticky Note - Alerts",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1440, 340]
    },
    {
      "parameters": {
        "jsCode": "// Check if it's time for periodic summary (every 24h at midnight)\nconst now = new Date();\nconst hour = now.getUTCHours();\n\n// Send summary at midnight UTC (or first check of the day)\nconst shouldSendSummary = hour >= 0 && hour < 6;\n\nreturn [{\n  json: {\n    ...$input.first().json,\n    shouldSendSummary\n  }\n}];"
      },
      "id": "check-summary-time",
      "name": "Check Summary Time",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1220, 900]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-send",
              "leftValue": "={{$json.shouldSendSummary}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "send-periodic-summary",
      "name": "Send Periodic Summary?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1440, 900]
    },
    {
      "parameters": {
        "sendTo": "={{$env.WISEBOT_OPS_EMAIL || 'ops@example.com'}}",
        "subject": "ðŸ“Š WiseBot Daily Operations Summary",
        "message": "**WiseBot Daily Operations Summary**\n\n**Report Generated:** {{$json.timestamp}}\n**System Status:** {{$json.overallStatus.toUpperCase()}}\n\n---\n\n## Health Checks\n\n**Database:** {{$json.checks.database.status}} âœ“\n\n**Processing Failures (Last 6h):** {{$json.checks.failedExecutions.count}}\n{{$json.checks.failedExecutions.status === 'healthy' ? 'âœ… All clear' : 'âš ï¸ Review required'}}\n\n---\n\n## Storage Metrics\n\n| Metric | Value |\n|--------|-------|\n| Total Documents | {{$json.checks.storage.totalDocuments}} |\n| Total Chunks | {{$json.checks.storage.totalChunks}} |\n| Avg Chunks/Doc | {{$json.checks.storage.avgChunksPerDoc}} |\n\n---\n\n## Duplicate Detection (Last 6h)\n\n- Exact Duplicates Blocked: {{$json.checks.duplicates.recentExact}}\n- Fuzzy Duplicates Flagged: {{$json.checks.duplicates.recentFuzzy}}\n\n---\n\n*This is an automated report from WiseBot Operations Dashboard.*\n*Check ID: {{$json.checkId}}*",
        "options": {}
      },
      "id": "send-daily-summary",
      "name": "Send Daily Summary",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1660, 800],
      "credentials": {
        "gmailOAuth2": {
          "id": "GMAIL_CREDENTIAL_ID",
          "name": "Gmail OAuth2"
        }
      }
    },
    {
      "parameters": {},
      "id": "end-success",
      "name": "End",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1880, 900]
    },
    {
      "parameters": {
        "content": "## Periodic Summary\n\n**Schedule:** Daily (first check of day)\n**Content:**\n- Overall system health\n- Processing statistics\n- Storage metrics\n- Duplicate detection stats\n\n**Format:** HTML-friendly email with tables",
        "height": 200,
        "width": 260
      },
      "id": "sticky-summary",
      "name": "Sticky Note - Summary",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1660, 540]
    },
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "wisebot/health",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "health-webhook",
      "name": "Health Check Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 600],
      "webhookId": "wisebot-health"
    },
    {
      "parameters": {
        "jsCode": "// Quick health check for webhook\nconst startTime = Date.now();\n\n// Return basic health info\nreturn [{\n  json: {\n    status: 'ok',\n    service: 'WiseBot',\n    timestamp: new Date().toISOString(),\n    uptime: process.uptime ? process.uptime() : 'N/A'\n  }\n}];"
      },
      "id": "quick-health",
      "name": "Quick Health Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 600]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{JSON.stringify($json)}}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "respond-health",
      "name": "Respond Health",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [680, 600]
    },
    {
      "parameters": {
        "content": "## Quick Health Endpoint\n\n**GET /webhook/wisebot/health**\n\nLightweight health check for monitoring tools (Pingdom, UptimeRobot, etc.)\n\nReturns:\n```json\n{\n  \"status\": \"ok\",\n  \"service\": \"WiseBot\",\n  \"timestamp\": \"...\"\n}\n```",
        "height": 220,
        "width": 280
      },
      "id": "sticky-health-endpoint",
      "name": "Sticky Note - Health Endpoint",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [240, 820]
    }
  ],
  "connections": {
    "Schedule (Every 6 Hours)": {
      "main": [
        [
          {
            "node": "Initialize Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Health Check": {
      "main": [
        [
          {
            "node": "Check DB Connectivity",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Failed Executions",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Processing Stats",
            "type": "main",
            "index": 0
          },
          {
            "node": "Count Total Documents",
            "type": "main",
            "index": 0
          },
          {
            "node": "Count Total Chunks",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Recent Duplicates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check DB Connectivity": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Failed Executions": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Processing Stats": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Count Total Documents": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Count Total Chunks": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Recent Duplicates": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "Store Health Check",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Critical Issues?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Summary Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Critical Issues?": {
      "main": [
        [
          {
            "node": "Send Critical Alert",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Send Critical Alert": {
      "main": [
        [
          {
            "node": "End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Summary Time": {
      "main": [
        [
          {
            "node": "Send Periodic Summary?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Periodic Summary?": {
      "main": [
        [
          {
            "node": "Send Daily Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Daily Summary": {
      "main": [
        [
          {
            "node": "End",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Health Check Webhook": {
      "main": [
        [
          {
            "node": "Quick Health Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Quick Health Check": {
      "main": [
        [
          {
            "node": "Respond Health",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [
    {
      "name": "WiseBot",
      "id": "wisebot-tag"
    },
    {
      "name": "Operations",
      "id": "ops-tag"
    }
  ],
  "triggerCount": 2,
  "updatedAt": "2024-01-01T00:00:00.000Z",
  "versionId": "1.0.0"
}
