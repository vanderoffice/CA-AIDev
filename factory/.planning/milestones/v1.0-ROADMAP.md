# Milestone v1.0: Factory MVP

**Status:** SHIPPED 2026-02-08
**Phases:** 1-7
**Total Plans:** 17

## Overview

Build a factory — skills, templates, and scripts — that standardizes the path from "new government domain" to "deployed on vanderdev.net." Start with the RAG pipeline foundation, then build scaffolding, research, n8n, and frontend layers in parallel, wire up deploy automation, and finish with the top-level orchestrator that ties everything into one command.

## Phases

### Phase 1: Foundation
**Goal**: Create the factory home directory and standardize the RAG ingest pipeline (chunk, embed, validate) generalized from WaterBot. Migrate existing bot RAG tables to `{schema}.document_chunks` standard. Create knowledge document template.
**Depends on**: Nothing (first phase)
**Plans**: 3 plans

Plans:
- [x] 01-01: Factory directory structure + README + .env.example
- [x] 01-02: RAG pipeline scripts (chunk-knowledge.js, embed-chunks.py, validate-knowledge.py)
- [x] 01-03: Knowledge templates + existing bot RAG table migration

**Details:**
- Directory tree mirrors 7-phase build order, each subdirectory annotated with populating phase
- .env.example uses Tailscale IP placeholder (reflects actual VPS access pattern)
- Zero npm deps for chunker (Node.js stdlib only)
- content_hash UNIQUE constraint for dedup (skip-duplicates instead of truncate-by-default)
- Knowledge template: 7-field YAML frontmatter, H2 chunk boundaries
- Decision tree JSON Schema (draft-07, derived from WaterBot production data)
- Migration SQL corrected plan's assumptions about BizBot schema and cross-database locations

### Phase 2: Scaffolder
**Goal**: Bootstrap a new bot or form project in one command. Create GSD roadmap templates for both tracks (9 phases each).
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: scaffold.sh script (bot + form tracks) + CLAUDE.md templates
- [x] 02-02: GSD roadmap templates (bot-ROADMAP.md + form-ROADMAP.md)

**Details:**
- scaffold.sh: 337 lines, relative symlinks for default layout, absolute for custom --output-dir
- sed-based template substitution with 5 placeholders (pipe delimiter avoids path conflicts)
- Bot track parallel-capable, form track strictly sequential (reflects coupling differences)
- Templates generalized from WaterBot (12 phases) and ECOS (7 phases)

### Phase 3: Research & Decks
**Goal**: Multi-perspective research orchestration (5 parallel subagents) with triple output (stakeholder brief, developer assessment, Memory entities). Dual presentation deck templates and generation skill. Research-to-knowledge conversion.
**Depends on**: Phase 1
**Plans**: 3 plans

Plans:
- [x] 03-01: research-domain.md skill (5 subagent perspectives + triple output)
- [x] 03-02: Presentation deck templates (stakeholder + technical) + build-decks.md skill
- [x] 03-03: research-to-knowledge.md skill + SKILL.md index

**Details:**
- 5 perspectives: Legal & Regulatory, Stakeholder, Technical, Fiscal, Existing Systems
- ToolSearch required before Perplexity/Memory MCP calls (deferred tools must be loaded first)
- build-decks invokes /deck --present (skill orchestrates skill, keeps pipeline DRY)
- research-to-knowledge produces two files per domain ({slug}-overview.md + {slug}-technical.md)
- SKILL.md follows /deck SKILL.md pattern for consistent skill documentation

### Phase 4: n8n Templates
**Goal**: Importable n8n workflow JSON for standard bot backends — chat webhook, RAG orchestrator, and tool webhook with placeholder replacement.
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 04-01: Export + parameterize bot-chat-orchestrator.json and bot-tool-webhook.json
- [x] 04-02: README with import/placeholder guide

**Details:**
- Replaced bot-specific match_documents() with portable pgvector `<=>` operator SQL
- {{INTAKE_CONTEXT_BLOCK}} as single replaceable block (each bot has unique intake fields)
- Manual HTTP->Code->Postgres RAG pipeline (not VectorStore) — matches 8/9 production workflows
- bot-data-webhook.json is skeleton only (domain logic too specific to templatize)
- 26 placeholders consolidated into single cross-template reference table

### Phase 5: Bot Frontend
**Goal**: Extract shared components from WaterBot/KiddoBot/BizBot into reusable library. Create WaterBot-quality page template. Refactor existing bots to use shared components.
**Depends on**: Phase 1
**Plans**: 3 plans

Plans:
- [x] 05-01: Extract shared components (BotModeSelector, DecisionTreeView, BotChatInterface, RAGButton, autoLinkUrls)
- [x] 05-02: Factory bot page template (PageComponent.jsx.template + DecisionTree.json.template)
- [x] 05-03: Refactor existing bots (WaterBot, BizBot, KiddoBot) to use shared components

**Details:**
- Consolidated 3 divergent autoLinkUrls into one (KiddoBot as base — most comprehensive)
- Fixed BizBot negative lookbehind browser compat bug with placeholder technique
- accentColor prop with pre-built color maps (simpler consumer API)
- PageComponent.jsx.template: 280 lines, 9 placeholders, 4 modes
- DecisionTree.json.template: 7 nodes, 3 result variations
- Refactored all 3 bots: 1,827 lines removed (55% reduction), browser-verified

### Phase 6: Deploy Automation
**Goal**: Standardized deployment scripts for both bot and form tracks with verification.
**Depends on**: Phase 1, Phase 2
**Plans**: 2 plans

Plans:
- [x] 06-01: deploy-bot.sh + deploy-form.sh + setup-supabase-schema.sh
- [x] 06-02: DEPLOY-CHECKLIST.md + end-to-end verification

**Details:**
- Transaction-wrapped SQL for schema setup (BEGIN/COMMIT prevents partial creation)
- Default privileges + explicit GRANT (future tables auto-inherit grants)
- ERR trap with CURRENT_STEP (pinpoints exactly which step failed)
- Path-prefix validation requires leading / (catches /ecosform vs ecosform early)
- All scripts shellcheck-clean, --dry-run verified

### Phase 7: Factory Orchestrator
**Goal**: Wire everything into `/gov-factory:new-project` entry point, `/gov-factory:status` dashboard, and Memory MCP entity schema. End-to-end smoke test.
**Depends on**: All previous phases
**Plans**: 2 plans

Plans:
- [x] 07-01: new-project.md orchestrator skill + status.md dashboard + Memory entity schema
- [x] 07-02: End-to-end smoke test (scaffold -> research -> decks -> knowledge -> ingest -> deploy -> verify)

**Details:**
- new-project.md: 8-step pipeline with --skip-to recovery and --dry-run
- status.md: Memory-backed dashboard (lightweight queries, filesystem only on --refresh)
- MEMORY-SCHEMA.md: 3 entity types, 3 relation types, {slug}_{type} naming
- Smoke test validated all 28+ factory components
- Skill files not committed to factory repo (Claude Code convention for user-level commands)

---

## Milestone Summary

**Decimal Phases:**
None — all phases executed in original order without urgent insertions.

**Key Decisions:**
- WaterBot as bot template base (quality over brevity)
- Two HTML decks per project via /deck (presentation-ready by default)
- Migrate all existing bots to standard RAG naming (consistency over grandfathering)
- Subagents for research (stable today; upgrade path documented)
- Factory in CA-AIDev/factory/ (adjacent to bot projects)
- Two tracks: bot + form (batch processing fits as bot variant)
- Zero npm deps for RAG chunker (portability)
- Portable pgvector SQL instead of match_documents() (reusability)

**Issues Resolved:**
- BizBot migration SQL corrected (JSONB metadata, not 15+ dedicated columns)
- Cross-database assumption corrected (both bots in postgres DB, not n8n)
- BizBot negative lookbehind browser compat fixed with placeholder technique
- MIN_CHUNK_SIZE filtering added for runt chunks after large-chunk splitting
- VPS weather collector 401 from stale InfluxDB token (fixed during bot verification)
- VPS mesh network blank pane from missing volume mount (fixed during bot verification)

**Issues Deferred:**
- SKILL.md path references `factory/templates/` vs root `templates/` — cosmetic, does not affect automation
- No shellcheck verification on scripts before Phase 6 (shellcheck installed at that point)

**Technical Debt Incurred:**
- None significant — factory is tooling, not production infrastructure

---

_For current project status, see .planning/ROADMAP.md_
