---
phase: 07-factory-orchestrator
plan: 01
type: execute
---

<objective>
Create the top-level factory orchestrator skill (`new-project.md`), a project status dashboard skill (`status.md`), and a Memory MCP entity schema document. Update SKILL.md to reflect the complete factory skill catalog.

Purpose: Wire all factory phases (1-6) into a single entry point that takes a domain name + track and orchestrates the full pipeline. Provide visibility into active projects via Memory-backed status dashboard.
Output: Two new skill files in `~/.claude/commands/gov-factory/`, one schema doc in factory repo, updated SKILL.md.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph (all phases feed into orchestrator):
@.planning/phases/02-scaffolder/02-01-SUMMARY.md
@.planning/phases/03-research-decks/03-01-SUMMARY.md
@.planning/phases/03-research-decks/03-02-SUMMARY.md
@.planning/phases/03-research-decks/03-03-SUMMARY.md
@.planning/phases/06-deploy-automation/06-01-SUMMARY.md
@.planning/phases/06-deploy-automation/06-02-SUMMARY.md

# Key files — existing skills to orchestrate:
@~/.claude/commands/gov-factory/SKILL.md
@~/.claude/commands/gov-factory/research-domain.md
@~/.claude/commands/gov-factory/build-decks.md
@~/.claude/commands/gov-factory/research-to-knowledge.md

# Key files — existing scripts invoked by orchestrator:
@factory/factory/scripts/scaffold.sh
@factory/factory/scripts/chunk-knowledge.js
@factory/factory/scripts/embed-chunks.py
@factory/factory/scripts/validate-knowledge.py
@factory/factory/scripts/setup-supabase-schema.sh
@factory/factory/scripts/deploy-bot.sh
@factory/factory/scripts/deploy-form.sh
@factory/factory/DEPLOY-CHECKLIST.md

**Tech stack available:** Perplexity MCP, Memory MCP, Task tool (subagents), ToolSearch, /deck skill
**Established patterns:** skill-orchestrates-skill (build-decks → /deck), parallel-subagent-dispatch, {{PLACEHOLDER}} convention, sed-template-substitution, domain-prefixed Memory entities
**Constraining decisions:**
- Phase 2: scaffold.sh uses --track/--name/--title flags, sed-based substitution
- Phase 3: research-domain outputs to output/research/, build-decks invokes /deck --present, research-to-knowledge is independent of build-decks
- Phase 3: ToolSearch required before any Perplexity/Memory MCP calls (deferred tools)
- Phase 4: n8n templates use same {{PLACEHOLDER}} convention, 26 placeholders across 3 templates
- Phase 6: deploy scripts use --name/--dry-run flags, setup-supabase-schema uses --schema/--track
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create new-project.md orchestrator skill</name>
  <files>~/.claude/commands/gov-factory/new-project.md</files>
  <action>
Create the top-level entry point skill that orchestrates the full factory pipeline. Follow the exact same skill file structure as research-domain.md (YAML frontmatter → overview → arguments → required tools → execution flow → output).

**Arguments:**
- `domain` (required) — quoted domain description (e.g., "water rights permitting")
- `--track bot|form` (required) — project track
- `--name <slug>` (optional) — override auto-generated slug from domain
- `--title "Display Name"` (optional) — override auto-generated title from domain
- `--skip-to <step>` (optional) — resume from a specific pipeline step (for recovering from failures)
- `--dry-run` (optional) — preview pipeline steps without executing

**Pipeline steps (in order):**
1. **Parse & validate** — Extract domain slug from description (lowercase, hyphens, max 50 chars). Derive name/title if not provided. Validate track is bot or form.
2. **Scaffold** — Run `factory/factory/scripts/scaffold.sh --track {track} --name {name} --title "{title}"`. Verify output directory created.
3. **Research** — Invoke `/gov-factory:research-domain "{domain}"` from the scaffolded project directory. Wait for completion. Verify stakeholder-brief.md and developer-assessment.md exist.
4. **Build decks** — Invoke `/gov-factory:build-decks "{slug}"`. Verify HTML deck files created.
5. **Research to knowledge** — Invoke `/gov-factory:research-to-knowledge "{slug}"`. Verify knowledge docs created.
6. **RAG ingest** (bot track only) — Run chunk-knowledge.js on knowledge docs, then embed-chunks.py with --schema {name}, then validate-knowledge.py with --schema {name}. Skip for form track.
7. **GSD init** — Remind user to run `/gsd:new-project` in the scaffolded directory to begin the build phase with the pre-populated roadmap template.
8. **Memory entities** — Create Memory MCP entities for the project: project entity (name, track, domain, status, created date), relates_to factory entity. Use ToolSearch to load Memory MCP tools first.

**Key implementation notes:**
- Use the Skill tool to invoke `/gov-factory:research-domain`, `/gov-factory:build-decks`, and `/gov-factory:research-to-knowledge` (skill-orchestrates-skill pattern from build-decks.md)
- Use Bash tool for scaffold.sh and RAG pipeline scripts
- Each step should verify its outputs before proceeding to next step
- If a step fails, report which step failed and suggest `--skip-to {next-step}` for recovery
- The `--skip-to` flag enables resuming after manual fixes without re-running completed steps
- Do NOT invoke deploy scripts — deployment happens after the build phase (separate from new-project)
- Include a progress display between steps showing pipeline completion
  </action>
  <verify>File exists at ~/.claude/commands/gov-factory/new-project.md, has YAML frontmatter with name/description/arguments, contains all 8 pipeline steps with verification checks, references correct script paths and skill names</verify>
  <done>new-project.md skill file created with complete pipeline orchestration, --skip-to recovery, --dry-run preview, and Memory entity creation</done>
</task>

<task type="auto">
  <name>Task 2: Create status.md dashboard skill</name>
  <files>~/.claude/commands/gov-factory/status.md</files>
  <action>
Create a project status dashboard skill that reads Memory MCP to show all factory projects and their pipeline stage.

**Arguments:**
- `$ARGUMENTS` (optional) — project slug to show detail for a specific project, or empty for overview
- `--refresh` — re-scan filesystem to update Memory entities with current state

**Execution flow:**
1. Use ToolSearch to load Memory MCP tools (mcp__memory__search_nodes, mcp__memory__read_graph)
2. Search Memory for entities with entityType "factory_project"
3. For each project entity, extract: name, track, domain, status, pipeline_stage, created_date
4. If specific project slug provided, show detailed view (all observations, related entities, file paths)
5. If no argument, show overview table

**Overview display format:**
```
Government Automation Factory — Project Status

| Project | Track | Domain | Stage | Created |
|---------|-------|--------|-------|---------|
| waterbot | bot | water rights | deployed | 2026-01-15 |
| calfire | form | fire reporting | building | 2026-02-01 |

Pipeline stages: research → decks → knowledge → scaffold → building → deployed

Factory assets: 3 skills, 7 scripts, 10 templates, 3 n8n workflows
```

**Detail display format (when project slug provided):**
```
Project: waterbot
Track: bot
Domain: water rights permitting
Stage: deployed
Created: 2026-01-15

Pipeline Progress:
  [x] Research — water-rights-stakeholder-brief.md, water-rights-developer-assessment.md
  [x] Decks — water-rights-stakeholder-deck.html, water-rights-technical-deck.html
  [x] Knowledge — water-rights-overview.md, water-rights-technical.md
  [x] RAG Ingest — 42 chunks embedded
  [x] Build — /gsd complete
  [x] Deploy — live at vanderdev.net/waterbot
```

**If --refresh flag:** Walk the filesystem for known project directories (CA-AIDev/* and Automation/*), compare against Memory entities, update any stale data using mcp__memory__add_observations.

**Key notes:**
- If Memory has no factory_project entities yet, display empty state with instructions to run `/gov-factory:new-project`
- Keep the skill lightweight — Memory MCP is the source of truth, filesystem scan only on --refresh
- Follow same skill file structure as other gov-factory skills (YAML frontmatter, overview, arguments, execution flow)
  </action>
  <verify>File exists at ~/.claude/commands/gov-factory/status.md, has YAML frontmatter, reads from Memory MCP, handles both overview and detail views, supports --refresh flag</verify>
  <done>status.md skill file created with Memory-backed project overview, per-project detail view, and --refresh filesystem resync</done>
</task>

<task type="auto">
  <name>Task 3: Define Memory entity schema + update SKILL.md</name>
  <files>factory/factory/MEMORY-SCHEMA.md, ~/.claude/commands/gov-factory/SKILL.md</files>
  <action>
**Part A: Create MEMORY-SCHEMA.md** in factory/factory/ documenting the Memory MCP entity model used by gov-factory skills.

Entity types:
- `factory_project` — A project created by the factory. Observations: name, track (bot|form), domain, slug, status (active|deployed|archived), pipeline_stage, created_date, project_dir, schema_name
- `factory_domain` — A researched government domain. Observations: description, research_depth, research_date, stakeholder_brief_path, developer_assessment_path
- `factory_deployment` — A deployed project instance. Observations: url, deploy_date, deploy_script_used, vps_host

Relations:
- factory_project → researched_domain → factory_domain
- factory_project → deployed_as → factory_deployment
- factory_project → created_by → gov_automation_factory (singleton entity representing the factory itself)

Include examples of creating entities with mcp__memory__create_entities, adding observations with mcp__memory__add_observations, and querying with mcp__memory__search_nodes. Show the actual JSON payloads.

**Part B: Update SKILL.md** to reflect the complete factory skill catalog:
- Add new-project.md and status.md to the Skills section with invocation examples and output descriptions
- Update Pipeline Flow diagram to show the full orchestrated flow via new-project
- Update References Index with new skill files (new-project.md, status.md), new docs (MEMORY-SCHEMA.md, DEPLOY-CHECKLIST.md)
- Update Remaining Phases table — all phases complete
- Add n8n templates to References Index (bot-chat-orchestrator.json, bot-tool-webhook.json, bot-data-webhook.json)
- Add deploy scripts to References Index (setup-supabase-schema.sh, deploy-bot.sh, deploy-form.sh)
- Add bot frontend templates to References Index (PageComponent.jsx.template, DecisionTree.json.template)
- Update Established Patterns table with patterns from Phases 4-6

Do NOT rewrite sections that are already correct — only add missing content and update stale references.
  </action>
  <verify>MEMORY-SCHEMA.md exists in factory/factory/ with entity types, relations, and JSON examples. SKILL.md lists all 5 skills (research-domain, build-decks, research-to-knowledge, new-project, status), all scripts (7 total), all templates (10+), and n8n workflows (3). Remaining Phases table shows all complete.</verify>
  <done>MEMORY-SCHEMA.md created with full entity model. SKILL.md updated to reflect complete factory (Phases 1-7) with all skills, scripts, templates, and patterns.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `ls ~/.claude/commands/gov-factory/` shows: SKILL.md, build-decks.md, new-project.md, research-domain.md, research-to-knowledge.md, status.md
- [ ] `cat ~/.claude/commands/gov-factory/new-project.md | head -5` shows valid YAML frontmatter
- [ ] `cat ~/.claude/commands/gov-factory/status.md | head -5` shows valid YAML frontmatter
- [ ] `ls factory/factory/MEMORY-SCHEMA.md` exists
- [ ] SKILL.md references all 5 skills, 7 scripts, 3 n8n templates
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- new-project.md orchestrates full pipeline (scaffold → research → decks → knowledge → ingest → GSD → Memory)
- status.md reads from Memory MCP with overview + detail views
- MEMORY-SCHEMA.md defines entity model with examples
- SKILL.md is the complete factory index
</success_criteria>

<output>
After completion, create `.planning/phases/07-factory-orchestrator/07-01-SUMMARY.md`
</output>
