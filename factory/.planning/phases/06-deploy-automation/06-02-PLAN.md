---
phase: 06-deploy-automation
plan: 02
type: execute
---

<objective>
Create the deploy checklist document and run end-to-end dry-run verification of all deploy scripts.

Purpose: Ensure every deploy step is documented for human reference and that all scripts work correctly before real deployments.
Output: DEPLOY-CHECKLIST.md in factory root + verified scripts passing dry-run tests
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-deploy-automation/06-01-SUMMARY.md

# Key source files:
@factory/scripts/setup-supabase-schema.sh
@factory/scripts/deploy-bot.sh
@factory/scripts/deploy-form.sh
@factory/scripts/scaffold.sh
@factory/README.md
@factory/n8n-templates/README.md

**Tech stack available:** bash, shellcheck, ssh, docker, n8n REST API
**Established patterns:**
- Bot deploy: npm build → rsync dist/ to VPS
- Form deploy: rsync project → docker-compose up --build on VPS
- Schema setup: SQL via docker exec psql
- n8n workflows: import via REST API (POST /api/v1/workflows)
- Webhook URLs: hardcoded constants in JSX (no env var injection)

**Constraining decisions:**
- [04-01]: Manual HTTP→Code→Postgres RAG pipeline (not VectorStore node)
- [04-01]: Direct pgvector SQL with <=> operator
- [04-02]: Data webhook is skeleton, not working abstraction
- [05-01]: accentColor prop with pre-built color maps for bot theming
- [05-02]: 9 placeholders in JSX template (8 required + TOOL_NAME)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DEPLOY-CHECKLIST.md</name>
  <files>factory/DEPLOY-CHECKLIST.md</files>
  <action>
Create a comprehensive deploy checklist covering both tracks. This is a human reference document — not a script. It should cover the full deploy lifecycle including steps the scripts don't automate (n8n workflow import, DNS setup, App.jsx route registration).

**Structure:**

## Prerequisites (both tracks)
- VPS SSH access configured (ssh vps works)
- .env file created from factory/.env.example with DB_HOST, DB_PASSWORD, OPENAI_API_KEY
- Project scaffolded via scaffold.sh

## Bot Track Deploy

### 1. Schema Setup
- Command: `factory/scripts/setup-supabase-schema.sh --schema {name} --track bot`
- Verify: schema exists, document_chunks table created

### 2. Knowledge Ingest
- Chunk: `node scripts/chunk-knowledge.js --input knowledge/ --output chunks/`
- Embed: `python scripts/embed-chunks.py --schema {name} --table document_chunks`
- Validate: `python scripts/validate-knowledge.py --schema {name}`

### 3. n8n Workflow Setup
- Import templates from factory/n8n-templates/ via n8n REST API or UI
- Steps: (a) Open n8n UI at https://n8n.vanderdev.net, (b) Import bot-chat-orchestrator.json, (c) Replace all 26 placeholders per n8n-templates/README.md, (d) Configure credentials (OpenAI API key, Postgres connection), (e) Activate workflow, (f) Test webhook: `curl -X POST https://n8n.vanderdev.net/webhook/{name} -H "Content-Type: application/json" -d '{"message":"test"}'`
- Reference: factory/n8n-templates/README.md for full placeholder list

### 4. Bot Page Registration
- Add page component import to vanderdev-website/src/App.jsx
- Add Route: `<Route path="/{slug}" element={<{PascalName} />} />`
- Add sidebar link in navigation component if desired

### 5. Deploy
- Command: `factory/scripts/deploy-bot.sh --name {slug}`
- Verify: https://vanderdev.net/{slug} loads, chat works, decision tree renders

### 6. Post-Deploy
- Update project STATUS.md
- Run /gov-factory:build-decks for final presentation decks with live screenshots
- Store Memory MCP entities for the deployed project

## Form Track Deploy

### 1. Schema Setup
- Command: `factory/scripts/setup-supabase-schema.sh --schema {name} --track form`
- Then run project-specific SQL: `ssh vps "docker exec -i supabase-db psql -U postgres -d postgres" < sql/001-schema.sql`

### 2. Docker Setup
- Ensure project has: Dockerfile (multi-stage), docker-compose.prod.yml, nginx.conf
- Ensure VPS .env has VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY
- Ensure docker-compose.prod.yml has correct VIRTUAL_HOST, VIRTUAL_PATH, VIRTUAL_DEST labels

### 3. Deploy
- Command: `factory/scripts/deploy-form.sh --name {slug} --path-prefix /{slug}`
- Verify: https://vanderdev.net/{slug} loads

### 4. Post-Deploy
- Same as bot track: STATUS.md, decks, Memory entities

## Troubleshooting
- **502 Bad Gateway:** Container not on nginx-proxy network. Check `docker network connect` or docker-compose network config.
- **404 on sub-path:** nginx.conf inside container missing `try_files $uri $uri/ /index.html` (or equivalent with path prefix).
- **Schema not found in PostgREST:** Run `NOTIFY pgrst, 'reload schema'` via psql to refresh PostgREST cache. Or restart supabase-rest container.
- **Webhook returns 404:** n8n workflow not activated, or webhook path doesn't match.
- **Embedding dimension mismatch:** Ensure HNSW index uses vector_cosine_ops with 1536 dimensions (text-embedding-3-small standard).

Keep formatting clean — use code blocks for commands, bold for critical warnings, and checkboxes for steps that should be verified.
  </action>
  <verify>
    DEPLOY-CHECKLIST.md exists at factory/DEPLOY-CHECKLIST.md.
    Contains both "Bot Track" and "Form Track" sections.
    All script commands reference correct paths (factory/scripts/...).
    Troubleshooting section covers at least 4 common issues.
  </verify>
  <done>Checklist covers full deploy lifecycle for both tracks, references all 3 deploy scripts, includes n8n workflow import steps and troubleshooting</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end dry-run verification</name>
  <files>factory/scripts/setup-supabase-schema.sh, factory/scripts/deploy-bot.sh, factory/scripts/deploy-form.sh</files>
  <action>
Run comprehensive dry-run verification of all 3 deploy scripts from 06-01.

**Verification matrix:**

1. **setup-supabase-schema.sh:**
   - `--help` prints usage
   - `--schema testbot --track bot --dry-run` → valid SQL with CREATE SCHEMA, CREATE TABLE, CREATE INDEX, GRANT
   - `--schema testform --track form --dry-run` → CREATE SCHEMA + GRANT, no document_chunks
   - `--schema INVALID --track bot --dry-run` → error about invalid schema name
   - Missing --schema flag → error with usage
   - Missing --track flag → error with usage

2. **deploy-bot.sh:**
   - `--help` prints usage
   - `--name waterbot --dry-run` → shows npm build, rsync, curl sequence
   - Missing --name → error with usage

3. **deploy-form.sh:**
   - `--help` prints usage
   - `--name ecos --path-prefix /ecosform --dry-run` → shows rsync, docker-compose, health check, curl sequence
   - Missing --name → error with usage
   - Missing --path-prefix → error with usage

4. **shellcheck all 3 scripts** — fix any errors (warnings acceptable).

5. **Verify all 3 are chmod +x** — fix if not.

If any test fails, fix the script and re-run. Do NOT proceed with a failing script.

After verification passes, update factory/README.md to add the 3 new scripts to the Scripts table (matching existing format for chunk-knowledge.js, embed-chunks.py, validate-knowledge.py). Also add a "## Deploy" section to README referencing DEPLOY-CHECKLIST.md.
  </action>
  <verify>
    All --help commands succeed.
    All --dry-run commands produce expected output.
    All error cases produce errors (not success).
    shellcheck passes on all 3 scripts.
    factory/README.md Scripts table has 6 entries (3 existing + 3 new).
  </verify>
  <done>All 3 scripts pass dry-run verification matrix, shellcheck clean, README updated with new scripts and deploy section. Phase 6 complete.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] DEPLOY-CHECKLIST.md exists and covers both tracks end-to-end
- [ ] All 3 deploy scripts pass --dry-run verification
- [ ] shellcheck passes on all 3 scripts
- [ ] factory/README.md updated with new scripts and deploy section
- [ ] No hardcoded credentials anywhere
- [ ] All scripts follow consistent conventions (flag parsing, error handling, usage output)
</verification>

<success_criteria>

- DEPLOY-CHECKLIST.md created with full lifecycle coverage
- All scripts verified via dry-run matrix
- README.md updated to document new deploy tooling
- Phase 6 complete — deploy automation ready for Phase 7 orchestrator
</success_criteria>

<output>
After completion, create `.planning/phases/06-deploy-automation/06-02-SUMMARY.md`
</output>
