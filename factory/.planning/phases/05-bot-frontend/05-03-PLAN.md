---
phase: 05-bot-frontend
plan: 03
type: execute
---

<objective>
Refactor WaterBot, BizBot, and KiddoBot to use shared components from src/lib/bots/, eliminating duplicated code while preserving all existing functionality.

Purpose: Prove the shared library works with real bots, reduce maintenance burden, and ensure bug fixes propagate to all bots from a single source.
Output: All 3 bot pages refactored to import from lib/bots/, with ~25-30% line reduction per bot page.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-bot-frontend/05-01-SUMMARY.md
@.planning/phases/05-bot-frontend/05-02-SUMMARY.md

Shared library (created in 05-01):
@/Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/index.js

Bot pages to refactor:
@/Users/slate/Documents/GitHub/vanderdev-website/src/pages/WaterBot.jsx (1,311 lines)
@/Users/slate/Documents/GitHub/vanderdev-website/src/pages/BizBot.jsx (572 lines)
@/Users/slate/Documents/GitHub/vanderdev-website/src/pages/KiddoBot.jsx (1,420 lines)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor WaterBot to use shared components</name>
  <files>
    /Users/slate/Documents/GitHub/vanderdev-website/src/pages/WaterBot.jsx
  </files>
  <action>
    Refactor WaterBot.jsx (1,311 lines) to import and use shared components from lib/bots/.

    **Replace inline autoLinkUrls** (lines ~98-150) with import from lib/bots/:
    ```
    import { autoLinkUrls, ChatMessage, DecisionTreeView, RAGButton } from '../lib/bots';
    ```

    **Replace inline message rendering** with ChatMessage component. Find all instances of the ReactMarkdown+autoLinkUrls pattern in the chat rendering section and replace with `<ChatMessage message={msg} />`.

    **Replace inline decision tree navigation** in the Permit Finder and Funding Navigator sections with DecisionTreeView. WaterBot has TWO decision trees (permit-decision-tree.json and funding-decision-tree.json), each with their own inline path-based navigation. Replace both with:
    ```jsx
    <DecisionTreeView
      tree={permitDecisionTree}
      onResult={handlePermitResult}
      onBack={() => setMode('choice')}
      title="Permit Finder"
      ragButton={<RAGButton webhookUrl={PERMIT_WEBHOOK} />}
    />
    ```

    **Replace inline RAG button** logic (the "Get More Details" buttons on result nodes) with RAGButton component. WaterBot currently has inline fetch→loading→display logic for each tree.

    **Preserve:**
    - All WaterBot-specific state (waterContext, mode states, session handling)
    - IntakeForm import from components/waterbot/IntakeForm
    - Choice screen layout and content
    - Webhook URLs and session ID handling
    - All 3 webhook endpoints (chat, permits, funding)
    - Source citation display specific to WaterBot

    **Do NOT change:**
    - Any CSS/Tailwind classes beyond what's needed for component swap
    - The IntakeForm component (stays in components/waterbot/)
    - The choice screen design
    - Any webhook call signatures

    Target: ~900-950 lines (down from 1,311 — approximately 350-400 lines removed).
  </action>
  <verify>
    - WaterBot.jsx no longer contains inline autoLinkUrls function definition
    - WaterBot.jsx no longer contains inline decision tree path navigation logic
    - WaterBot.jsx imports from '../lib/bots'
    - Line count reduced by approximately 300-400 lines
    - All 3 modes still present: choice, chat, permit finder, funding navigator
  </verify>
  <done>
    - WaterBot uses shared autoLinkUrls, ChatMessage, DecisionTreeView, and RAGButton
    - No inline duplication of any shared pattern
    - All WaterBot-specific functionality preserved (3 webhooks, 2 decision trees, intake form)
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor BizBot and KiddoBot to use shared components</name>
  <files>
    /Users/slate/Documents/GitHub/vanderdev-website/src/pages/BizBot.jsx,
    /Users/slate/Documents/GitHub/vanderdev-website/src/pages/KiddoBot.jsx
  </files>
  <action>
    **BizBot.jsx (572 lines):** Simpler refactor — BizBot has no decision tree in the main page (LicenseFinder is a separate component).

    Replace:
    - Inline autoLinkUrls (lines ~49-85, the version with the negative lookbehind bug) → import from lib/bots/
    - Inline message rendering → ChatMessage component
    - Add import: `import { autoLinkUrls, ChatMessage } from '../lib/bots';`

    BizBot does NOT use DecisionTreeView or RAGButton in the main page (LicenseFinder handles its own UI). Leave LicenseFinder unchanged.

    Target: ~470-490 lines (down from 572 — approximately 80-100 lines removed).

    **KiddoBot.jsx (1,420 lines):** Most complex refactor — has inline decision tree AND eligibility calculator.

    Replace:
    - Inline autoLinkUrls (lines ~602-656) → import from lib/bots/
    - Inline message rendering → ChatMessage component
    - Inline program finder decision tree navigation → DecisionTreeView component
    - Inline RAG "Get More Details" buttons on program results → RAGButton component
    - Add import: `import { autoLinkUrls, ChatMessage, DecisionTreeView, RAGButton } from '../lib/bots';`

    KiddoBot has the decision tree data INLINE in the component (~540 lines of JSON). Move this to a separate file: `src/data/kiddobot-program-tree.json` and import it. This is a major contributor to the line count.

    Preserve:
    - EligibilityCalculator import (stays in components/kiddobot/)
    - ProgramCard import (stays in components/kiddobot/)
    - Family context state and banner
    - All KiddoBot-specific intake and mode logic
    - Icon mapping for decision tree options

    Target: ~750-850 lines (down from 1,420 — approximately 550-650 lines removed, mostly from extracting inline JSON).

    **For both bots:** Verify that imports resolve correctly and no orphaned code remains (functions defined but never called after refactor).
  </action>
  <verify>
    - BizBot.jsx no longer contains inline autoLinkUrls (especially the negative lookbehind version)
    - BizBot.jsx imports from '../lib/bots'
    - KiddoBot.jsx no longer contains inline autoLinkUrls or decision tree navigation
    - KiddoBot.jsx imports from '../lib/bots'
    - KiddoBot inline decision tree JSON moved to src/data/kiddobot-program-tree.json
    - No orphaned function definitions in either file
    - Combined line reduction: ~650-750 lines across both files
  </verify>
  <done>
    - BizBot uses shared autoLinkUrls and ChatMessage (no decision tree needed in main page)
    - KiddoBot uses all 4 shared components + extracted JSON data file
    - Both bots preserve all existing functionality and domain-specific components
    - Negative lookbehind regex bug eliminated from BizBot
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Refactored all 3 bot pages (WaterBot, BizBot, KiddoBot) to use shared components from src/lib/bots/. WaterBot: ~350-400 lines removed. BizBot: ~80-100 lines removed. KiddoBot: ~550-650 lines removed (including inline JSON extraction).</what-built>
  <how-to-verify>
    1. Run: `cd /Users/slate/Documents/GitHub/vanderdev-website && npm run dev`
    2. Visit: http://localhost:5173/waterbot
       - Verify choice screen renders (3 options)
       - Click "Permit Finder" — verify decision tree navigation works (select options, back, restart)
       - Click "Ask WaterBot" — verify chat sends messages and renders markdown responses
       - Verify links in chat responses are clickable (autoLinkUrls working)
    3. Visit: http://localhost:5173/bizbot
       - Verify choice screen renders
       - Click "Ask BizBot" — verify chat works, markdown renders, links are clickable
       - Verify FAQ chips and suggested questions appear in empty state
    4. Visit: http://localhost:5173/kiddobot
       - Verify choice screen renders
       - Click "Program Finder" — verify decision tree navigation works
       - Click "Ask KiddoBot" — verify chat works
       - Verify "Get More Details" RAG button works on program results (if webhook is available)
    5. Check browser console for errors on all 3 pages
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 5, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 bot pages import from '../lib/bots'
- [ ] No inline autoLinkUrls definitions remain in any bot page
- [ ] No inline decision tree navigation logic remains in WaterBot or KiddoBot
- [ ] KiddoBot decision tree JSON extracted to src/data/
- [ ] Total line reduction across all 3 pages: ~1,000-1,150 lines
- [ ] Human verification confirms all 3 bots function correctly
</verification>

<success_criteria>

- All tasks completed including human verification checkpoint
- WaterBot, BizBot, KiddoBot all use shared lib/bots/ components
- No functionality regression — all existing features work
- Significant line reduction demonstrating real duplication removal
- BizBot's negative lookbehind regex bug eliminated
- KiddoBot's inline JSON extracted to separate data file
</success_criteria>

<output>
After completion, create `.planning/phases/05-bot-frontend/05-03-SUMMARY.md`
</output>
