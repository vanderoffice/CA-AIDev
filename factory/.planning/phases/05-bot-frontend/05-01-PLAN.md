---
phase: 05-bot-frontend
plan: 01
type: execute
---

<objective>
Extract shared bot components from WaterBot, BizBot, and KiddoBot into a reusable library within vanderdev-website.

Purpose: Eliminate triple-duplicated code (autoLinkUrls, chat message rendering, decision tree navigation) and establish the shared component foundation that Plans 05-02 and 05-03 depend on.
Output: `src/lib/bots/` directory with 5 shared modules — autoLinkUrls, ChatMessage, BotChatInterface, DecisionTreeView, RAGButton.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Source files to extract from (in vanderdev-website repo):
@/Users/slate/Documents/GitHub/vanderdev-website/src/pages/WaterBot.jsx
@/Users/slate/Documents/GitHub/vanderdev-website/src/pages/BizBot.jsx
@/Users/slate/Documents/GitHub/vanderdev-website/src/pages/KiddoBot.jsx
@/Users/slate/Documents/GitHub/vanderdev-website/src/components/BotHeader.jsx
@/Users/slate/Documents/GitHub/vanderdev-website/src/hooks/useBotPersistence.js

Existing shared components (already extracted — reference for patterns):
- BotHeader.jsx (103 lines) — shared across all 3 bots
- useBotPersistence.js (117 lines) — shared hook for session state

Key finding: autoLinkUrls is duplicated 3 times with divergent implementations:
- WaterBot (lines ~98-150): Conservative, no phone numbers
- BizBot (lines ~49-85): Uses negative lookbehind (browser compatibility issue)
- KiddoBot (lines ~602-656): Most comprehensive — handles phone numbers, angle brackets, bare domains
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract autoLinkUrls utility + ChatMessage component</name>
  <files>
    /Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/autoLinkUrls.js,
    /Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/ChatMessage.jsx,
    /Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/index.js
  </files>
  <action>
    Create `src/lib/bots/` directory in vanderdev-website.

    **autoLinkUrls.js:** Consolidate the best implementation (KiddoBot's, lines ~602-656) which handles:
    - Markdown link protection (placeholder technique to avoid double-linking)
    - Email addresses → mailto: links
    - Phone numbers → tel: links (KiddoBot-only feature, missing from WaterBot/BizBot)
    - Bare domains (e.g., water.ca.gov) → https:// links
    - Angle bracket URLs
    - Plain http/https URLs

    Fix BizBot's negative lookbehind regex compatibility issue — use the placeholder technique instead (as WaterBot and KiddoBot already do). Export as named function.

    **ChatMessage.jsx:** Extract the message rendering pattern duplicated in all 3 bots:
    ```
    {role === 'user' ? (
      <p className="text-sm">{content}</p>
    ) : (
      <div className="prose prose-invert prose-sm max-w-none">
        <ReactMarkdown remarkPlugins={[remarkGfm]}>{autoLinkUrls(content)}</ReactMarkdown>
      </div>
    )}
    ```
    Props: `message` ({role, content}), optional `className`. Import ReactMarkdown and remarkGfm internally. Import autoLinkUrls from ./autoLinkUrls. Include the timestamp display and source citation rendering if present in message.sources.

    **index.js:** Barrel export for all shared bot modules. Start with `export { autoLinkUrls } from './autoLinkUrls'` and `export { ChatMessage } from './ChatMessage'`.
  </action>
  <verify>
    - Files exist at src/lib/bots/autoLinkUrls.js, src/lib/bots/ChatMessage.jsx, src/lib/bots/index.js
    - autoLinkUrls handles all 6 link types (markdown protection, emails, phones, bare domains, angle brackets, plain URLs)
    - ChatMessage renders user messages as plain text and assistant messages as markdown with autoLinkUrls
    - No negative lookbehind regex used (browser compat fix)
    - Barrel export re-exports all modules
  </verify>
  <done>
    - autoLinkUrls.js is a single consolidated implementation covering all link types from all 3 bots
    - ChatMessage.jsx renders both user and assistant messages with proper styling and markdown
    - index.js barrel exports both modules
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract DecisionTreeView + RAGButton components</name>
  <files>
    /Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/DecisionTreeView.jsx,
    /Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/RAGButton.jsx,
    /Users/slate/Documents/GitHub/vanderdev-website/src/lib/bots/index.js
  </files>
  <action>
    **DecisionTreeView.jsx:** Extract the decision tree navigation pattern shared by WaterBot (permit finder + funding navigator) and KiddoBot (program finder). All use the same state pattern:
    - `path` array tracks navigation history (node keys visited)
    - Current node = last element of path (or root)
    - Option selection → push next node key to path
    - Back → pop last element from path
    - Restart → reset path to empty/root

    Props:
    - `tree` — the decision tree JSON object (meta + nodes)
    - `onResult` — callback when reaching a result node (receives node data)
    - `onBack` — callback for exiting the tree entirely
    - `title` — display title for the tree header
    - `ragButton` — optional render prop or component for the RAG "Get More Details" button on result nodes
    - `iconMap` — optional map of option IDs to icon components (KiddoBot uses this)
    - `className` — optional container class

    Node rendering:
    - Question nodes: title, helpText (if present), option buttons with labels and optional icons
    - Result nodes: title, description, links (if present), optional RAG button, optional metadata fields
    - Navigation breadcrumb or step indicator showing depth

    Do NOT couple to any bot-specific styling. Use the existing Tailwind dark theme classes (bg-gray-800, text-gray-100, etc.) matching vanderdev-website's design system. Keep the component generic — bot-specific result card layouts (ProgramCard, LicenseCard) stay in their bot directories and get passed via render props or children.

    **RAGButton.jsx:** Extract the "Get More Details" pattern from WaterBot's permit/funding result nodes:
    Props:
    - `webhookUrl` — the n8n webhook endpoint to call
    - `query` — the ragQuery string from the result node
    - `context` — optional bot context object sent with the request
    - `onResult` — callback with RAG response text
    - `className` — optional

    State: idle → loading (spinner) → result (shows response) or error.
    Uses fetch() to POST to webhook URL with {query, ...context}.
    Display: Button in idle state, spinner during load, markdown-rendered response after.

    **Update index.js** to add exports for DecisionTreeView and RAGButton.
  </action>
  <verify>
    - DecisionTreeView.jsx handles: path-based navigation, question nodes with options, result nodes with optional RAG button, back/restart, icon mapping
    - RAGButton.jsx handles: idle/loading/result/error states, webhook POST, markdown response rendering
    - index.js exports all 4 modules (autoLinkUrls, ChatMessage, DecisionTreeView, RAGButton)
    - No bot-specific logic (no waterbot/bizbot/kiddobot references) in any shared component
  </verify>
  <done>
    - DecisionTreeView is generic enough for both WaterBot's permit/funding trees and KiddoBot's program tree
    - RAGButton is a standalone component handling the full fetch→display lifecycle
    - All 4 shared modules exported from index.js barrel
    - Zero bot-specific coupling in shared library
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `src/lib/bots/` directory exists with 5 files (autoLinkUrls.js, ChatMessage.jsx, DecisionTreeView.jsx, RAGButton.jsx, index.js)
- [ ] No bot-specific imports or references in any shared module
- [ ] All shared modules use vanderdev-website design system classes (dark theme, Inter font stack)
- [ ] Barrel export covers all 4 public modules
- [ ] No negative lookbehind regex in autoLinkUrls (browser compat)
</verification>

<success_criteria>

- 5 files created in src/lib/bots/
- autoLinkUrls consolidates all 3 divergent implementations into one comprehensive version
- ChatMessage eliminates triple-duplicated message rendering
- DecisionTreeView generalizes the path-based tree navigation from WaterBot and KiddoBot
- RAGButton extracts the webhook-based "Get More Details" pattern
- All modules are generic — no bot names in the shared library
</success_criteria>

<output>
After completion, create `.planning/phases/05-bot-frontend/05-01-SUMMARY.md`
</output>
