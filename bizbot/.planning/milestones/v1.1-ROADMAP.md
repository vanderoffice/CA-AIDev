# Milestone v1.1: Data Completeness

**Status:** ✅ SHIPPED 2026-02-16
**Phases:** 7-9
**Total Plans:** 6

## Overview

Improve License Finder data coverage and RAG pipeline maintainability — no UI changes. Resolved 3 deferred issues (ISS-002, ISS-003, ISS-004), enriched metadata on all 387 chunks, expanded city dropdown to 1,210 entries, and confirmed zero eval regressions.

## Phases

### Phase 7: License Data Expansion

**Goal**: Auto-include cross-industry general licenses (ISS-002) and seed city/county-specific permit data (ISS-003)
**Depends on**: v1.0 complete
**Plans**: 2

Plans:

- [x] 07-01: Cross-Industry General License Fix — `OR industry_code = 'general'` in n8n + `get_required_licenses()` DB function; DBA, SOI, BPP added (catalog 2→5)
- [x] 07-02: City/County License Data Seeding — 25 CA metros seeded with real fees, URLs, processing times; n8n dedup logic via `hasCityLicense` check

**Details:**
- ISS-002 resolved: General licenses auto-included in all industry queries
- ISS-003 resolved: City-specific data replaces generic "$50-$500" fallback for seeded cities
- 2 new agencies added: county_clerk, county_assessor
- 4 distinct city fee models documented: gross receipts (LA), employee-count (SD), classification-based (SF), flat fee (smaller cities)
- All new general licenses marked conditional to prevent false positives

### Phase 8: RAG Pipeline Improvements

**Goal**: Enrich metadata on ~60% of chunks using basic blob format, add DB timestamp columns for chunk-level staleness tracking, and expand city dropdown with unincorporated CDPs
**Depends on**: Phase 7
**Plans**: 3

Plans:

- [x] 08-01: Schema Migration + Metadata Enrichment — TIMESTAMPTZ columns with auto-update trigger; topic classification on all 387 chunks (8 categories), industry_category on 142 chunks (8 subcategories)
- [x] 08-02: Unincorporated Communities Dropdown Expansion — 728 CDPs added to CA_CITIES (482→1,210 total entries) using US Census Bureau 2020 data; pop >= 1,000 threshold with special county exemptions
- [x] 08-03: Ingest Pipeline Update + Verification — `infer_topic_metadata()` function added to chunk.py for future ingests; end-to-end Phase 8 verification passed across all 5 categories

**Details:**
- Timestamp columns enable `/bot-refresh` chunk-level staleness detection
- Topic metadata enables future filtered RAG retrieval
- `infer_topic_metadata()` is a safe no-op for WaterBot/KiddoBot knowledge dirs
- RAG quality gates: 0 duplicates, 0 NULL content, 0 NULL embeddings, 0 wrong dimensions

### Phase 9: Tooling & Verification

**Goal**: Fix WAF external POST blocking (ISS-004) and run final eval pass to validate all v1.1 changes
**Depends on**: Phase 8
**Plans**: 1

Plans:

- [x] 09-01: WAF Fix + Final v1.1 Eval — Root cause: X-Bot-Token auth in nginx-proxy vhost, not WAF. Added `N8N_WEBHOOK_HEADERS` to `bot_registry.py`; final eval 29S/6A/0W (zero regressions)

**Details:**
- ISS-004 root cause was `X-Bot-Token` header requirement in nginx-proxy Docker container vhost config
- Fix applied to audit tooling (`bot_registry.py` + `audit-webhooks.py`), not nginx config
- All 3 BizBot webhooks accessible externally with token
- Final eval identical to v1.0 baseline: 100% coverage, 29S/6A/0W

---

## Milestone Summary

**Key Decisions:**

- TEXT types in DB functions to match production schema (not VARCHAR from DDL)
- General licenses all conditional — DBA/SOI/BPP avoid false positives for sole props
- city_biz_lic_ prefix convention for city-specific license dedup detection
- hasCityLicense check placed before generic addition to prevent cost accumulator pollution
- Santa Clarita mapped to LA County TTC (city doesn't issue own business license)
- TIMESTAMPTZ over TIMESTAMP for timezone-aware staleness tracking
- No indexes on timestamp columns — batch queries only
- CDP population >= 1,000 threshold with special county exemptions
- (Unincorporated) suffix distinguishes CDPs from incorporated cities
- infer_topic_metadata() returns {} for unknown dirs — zero risk to other bots
- ISS-004 was X-Bot-Token auth, not WAF — fix in tooling, not infra

**Issues Resolved:**

- ISS-002: Cross-industry general licenses not auto-included → Fixed WHERE clause + expanded catalog
- ISS-003: City/county-specific license data not seeded → 25 CA metros + dedup logic
- ISS-004: External POST blocked (403) → X-Bot-Token auth added to audit tooling
- ~60% chunks with basic blob metadata → 100% topic coverage, 142 industry subcategories
- No timestamp tracking → TIMESTAMPTZ columns with auto-update trigger

**Issues Deferred:**

- ftb.ca.gov + bizfileonline.sos.ca.gov 403s remain (bot-blocking WAF, functional in browser)
- City-specific license data covers top 25 only — 457 cities use generic fallback
- Filtered RAG retrieval using topic metadata not yet implemented

**Technical Debt Incurred:**

- None — all v1.1 work is clean and complete

---

_For current project status, see .planning/ROADMAP.md_
