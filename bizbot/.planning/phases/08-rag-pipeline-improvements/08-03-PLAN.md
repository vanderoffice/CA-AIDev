---
phase: 08-rag-pipeline-improvements
plan: 03
type: execute
---

<objective>
Update the bot-ingest chunking pipeline to produce enriched metadata on future ingests and verify all Phase 8 work end-to-end.

Purpose: Ensure re-ingests don't regress metadata enrichment (currently, /bot-ingest --replace would overwrite enriched metadata with basic blob format). Also validate all Phase 8 artifacts (timestamps, enrichment, city dropdown).
Output: Updated chunk.py that produces enriched metadata, verification report confirming all Phase 8 success criteria.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries from this phase:
@.planning/phases/08-rag-pipeline-improvements/08-01-SUMMARY.md
@.planning/phases/08-rag-pipeline-improvements/08-02-SUMMARY.md

**Bot-ingest pipeline files:**
- Chunker: `~/.claude/commands/bot-ingest/scripts/chunk.py`
- Embedder: `~/.claude/commands/bot-ingest/scripts/embed.py`
- Inserter: `~/.claude/commands/bot-ingest/scripts/ingest.py`
- Verifier: `~/.claude/commands/bot-ingest/scripts/verify.py`

**Current chunk.py metadata output (basic blob):**
```json
{
  "content": "...",
  "metadata": {
    "source_file": "04_Industry_Requirements/Alcohol/ABC_Licensing_Guide.md",
    "section_heading": "License Types",
    "chunk_index": 0,
    "content_hash": "abc123..."
  }
}
```

**Target enriched metadata output:**
```json
{
  "content": "...",
  "metadata": {
    "source_file": "04_Industry_Requirements/Alcohol/ABC_Licensing_Guide.md",
    "section_heading": "License Types",
    "chunk_index": 0,
    "content_hash": "abc123...",
    "topic": "industry",
    "industry_category": "alcohol"
  }
}
```

**Constraining decisions:**
- ingest.py already detects if metadata JSONB column exists and stores full metadata JSON — no changes needed to ingest.py
- Production table is `bizbot_documents` with metadata JSONB column — ingest.py will store enriched metadata automatically
- chunk.py is shared across all bots — changes must not break WaterBot or KiddoBot ingestion
- The topic mapping is BizBot-specific (01_Entity, 02_State, etc.) — must be conditional on the knowledge directory structure

**RAG quality gates (from verify.py):**
1. Zero duplicates (COUNT(*) - COUNT(DISTINCT md5(content)) = 0)
2. Zero NULL content
3. Zero NULL embeddings
4. Correct dimension (1536)
5. Row count match (replace mode)
6. No corruption patterns
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add topic inference to chunk.py</name>
  <files>~/.claude/commands/bot-ingest/scripts/chunk.py</files>
  <action>
Modify chunk.py to infer `topic` and `industry_category` from the source_file path and add them to chunk metadata.

Add a function `infer_topic_metadata(source_file: str) -> dict` that:
1. Checks if source_file starts with a numbered directory pattern (`NN_Name/`)
2. Maps the number prefix to topic:
   - 01 → entity, 02 → state, 03 → local, 04 → industry,
   - 05 → environmental, 06 → renewal, 07 → special
3. For `04_Industry_Requirements/SUBDIR/`, extracts industry_category from subdirectory name (lowercase, underscored)
4. Returns `{"topic": "...", "industry_category": "..."}` or `{"topic": "..."}` or `{}` if no pattern matches

Call this function during chunk creation and merge the result into the metadata dict using `{**base_metadata, **infer_topic_metadata(source_file)}`.

Important constraints:
- This function MUST be a no-op for files that don't match numbered directory patterns — it returns `{}` for unknown structures, so WaterBot/KiddoBot knowledge dirs (which use different folder conventions) are unaffected
- Do NOT hardcode BizBot-specific file mappings (like "BizInterviews" → entity) — those are one-time enrichment handled by 08-01's SQL. The chunker should only do structural inference from directory naming
- Keep the function pure (no side effects, no DB calls)
- Add a brief comment explaining the mapping convention
  </action>
  <verify>
Test chunk.py locally with a BizBot knowledge file:
python3 ~/.claude/commands/bot-ingest/scripts/chunk.py ~/Documents/GitHub/CA-AIDev/bizbot/BizAssessment/04_Industry_Requirements/Alcohol/ABC_Licensing_Guide.md --max-chars 2000

Confirm output chunks have metadata with topic="industry" and industry_category="alcohol"

Test with a non-numbered file:
python3 ~/.claude/commands/bot-ingest/scripts/chunk.py ~/Documents/GitHub/CA-AIDev/bizbot/BizAssessment/README.md --max-chars 2000

Confirm output chunks have metadata WITHOUT topic (no crash, graceful empty dict merge)
  </verify>
  <done>chunk.py produces enriched metadata for numbered-directory files, no-ops for others, no regressions for WaterBot/KiddoBot knowledge structures</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end Phase 8 verification</name>
  <files>Production DB, LicenseFinder.jsx (read-only verification)</files>
  <action>
Run comprehensive verification of all Phase 8 deliverables:

1. **Timestamp verification:**
   - Confirm created_at and updated_at on all 387 rows
   - Test trigger: UPDATE one row's content, verify updated_at changes, then revert the content change

2. **Metadata enrichment verification:**
   - Query topic distribution: all 387 rows should have topic
   - Query industry_category distribution: ~147 industry rows should have it
   - Verify no metadata key regression: spot-check that source_file, section_heading, chunk_index, content_hash still present on 5 random rows

3. **City dropdown verification:**
   - Count total entries in CA_CITIES (target: >750)
   - Verify "(Unincorporated)" suffix present
   - Check counties with zero incorporated cities now have options (Alpine, Mariposa, Trinity)

4. **RAG quality gates:**
   - Run dedup check: COUNT(*) vs COUNT(DISTINCT md5(content))
   - Run NULL check: content and embedding
   - Run dimension check: array_length(embedding, 1) = 1536

5. **Build verification:**
   - Confirm VPS build still passes: ssh vps 'cd /root/vanderdev-website && npm run build'

Report results inline. If any check fails, fix before marking complete.
  </action>
  <verify>All 5 verification categories pass with zero failures</verify>
  <done>Phase 8 fully verified: timestamps functional, metadata enriched (100% topic coverage), city dropdown expanded, RAG quality gates pass, production build clean</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] chunk.py enriches metadata for numbered-directory files
- [ ] chunk.py is backwards-compatible (WaterBot/KiddoBot unaffected)
- [ ] All 387 chunks have topic metadata
- [ ] Timestamp columns functional with trigger
- [ ] City dropdown includes unincorporated CDPs
- [ ] RAG quality gates pass (dedup, NULLs, dimensions)
- [ ] VPS build succeeds
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No regressions on existing functionality
- Phase 8 complete — all three plans shipped
  </success_criteria>

<output>
After completion, create `.planning/phases/08-rag-pipeline-improvements/08-03-SUMMARY.md`:

Include:
- Verification results for all 5 categories
- chunk.py changes summary
- Any issues encountered
- "Phase 8 complete, ready for Phase 9"
</output>
