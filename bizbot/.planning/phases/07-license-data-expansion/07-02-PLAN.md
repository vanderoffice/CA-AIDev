---
phase: 07-license-data-expansion
plan: 02
type: execute
---

<objective>
Seed city-specific license data for the top 25 California metros (ISS-003) and update the n8n workflow to deduplicate city-specific results against the hardcoded generic City Business License.

Purpose: The License Finder currently returns a generic "City Business License ($50-$500)" for all queries because no city-specific data exists in the DB. With real city data, users get accurate fees, application URLs, and processing times for their specific city.
Output: 25+ city-specific license rows in `license_requirements`, updated n8n dedup logic, verified end-to-end.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md

# Prior plan in this phase (must complete 07-01 first):
@.planning/phases/07-license-data-expansion/07-01-SUMMARY.md

# Prior phase context (license DB patterns):
@.planning/phases/03-tool-rebuilds/03-02-SUMMARY.md

# Schema reference:
@BizBot_v4/database/03_license_requirements.sql
@BizBot_v4/workflows/07_license_finder_webhook.json

# Knowledge base (CalGOLD reference):
@BizAssessment/03_Local_Licensing/README.md

**Production-first doctrine:** All changes on VPS via SSH.
- DB changes: `ssh vps "docker exec -i supabase-db psql -U postgres -d postgres"`
- n8n workflow: Use n8n MCP tools or n8n API via SSH
- Build (if needed): `ssh vps "cd /root/vanderdev-website && npm run build"`

**Tech stack available:** Supabase PostgreSQL, n8n webhooks, React/Vite
**Established patterns:** PHASE_CONFIG constants, safe fetch pattern, production-first SSH

**Constraining decisions:**
- Phase 3: All 58 counties + 482 cities already in LicenseFinder.jsx frontend dropdowns
- n8n Postgres node already has city/county matching: `OR ($2 IS NOT NULL AND r.city = $2)`
- n8n Code node hardcodes generic "City Business License ($50-$500)" for ALL queries — needs dedup

**Issues being addressed:** ISS-003 (city/county-specific license data not seeded)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research and seed city-specific license data for top 25 CA metros</name>
  <files>license_requirements table, license_agencies table (via SSH psql)</files>
  <action>
  Research business license requirements for the top 25 California cities by population and INSERT city-specific rows into `license_requirements`.

  **Target cities (25):**
  Los Angeles, San Diego, San Jose, San Francisco, Fresno, Sacramento, Long Beach, Oakland, Bakersfield, Anaheim, Santa Ana, Riverside, Stockton, Irvine, Chula Vista, Santa Clarita, Fremont, Moreno Valley, Fontana, San Bernardino, Modesto, Glendale, Huntington Beach, Oxnard, Roseville

  **For each city, research and capture:**

  1. **City Business License/Tax Certificate** (primary — every city has one)
     - `license_name`: '[City] Business License' (e.g., 'Los Angeles Business Tax Registration Certificate')
     - `license_code`: 'city_biz_lic_[city_slug]' (e.g., 'city_biz_lic_los_angeles')
     - `agency_code`: Add city agency to `license_agencies` (e.g., code: 'city_los_angeles', name: 'City of Los Angeles Office of Finance', agency_type: 'city')
     - `industry_code`: 'general' (applies to all industries in that city)
     - `city`: exact city name matching `CA_CITIES` array in LicenseFinder.jsx (e.g., 'Los Angeles')
     - `county`: county name (e.g., 'Los Angeles')
     - `is_statewide`: false
     - `is_required`: true
     - `is_conditional`: false
     - `sequence_group`: 'local'
     - `sequence_order`: 40
     - `application_fee_min/max`: actual city fee range
     - `application_url`: city's online business license portal
     - `info_url`: city's business license info page
     - `processing_days_min/max`: typical processing time
     - `notes`: any city-specific requirements (e.g., "Gross receipts tax in LA", "Flat fee in smaller cities")

  2. **City-specific fire permit** (if the city requires a separate fire clearance beyond county)
     - Only add if the city explicitly requires a separate fire department business permit
     - `sequence_group`: 'local', `sequence_order`: 42
     - `is_conditional`: true, `condition_description`: 'Required for businesses with public access or hazardous materials'

  **Research approach:**
  - Use web search for each city: "[City Name] California business license application fee"
  - Check CalGOLD (https://calgold.ca.gov/) for permit listings by city
  - Cross-reference city official websites for accuracy
  - If fee data is unavailable for a city, use `application_fee_min = NULL` and note "Contact city for current fees" in notes

  **SQL pattern for each city:**
  ```sql
  -- Agency (if not exists)
  INSERT INTO license_agencies (code, name, abbreviation, url, agency_type)
  VALUES ('city_[slug]', 'City of [Name] [Dept]', '[ABBR]', '[url]', 'city')
  ON CONFLICT (code) DO NOTHING;

  -- Business License
  INSERT INTO license_requirements (
    license_name, license_code, agency_code, industry_code,
    city, county, is_required, is_conditional, sequence_group, sequence_order,
    application_fee_min, application_fee_max, application_url, info_url, notes
  ) VALUES (
    '[City] Business License', 'city_biz_lic_[slug]', 'city_[slug]', 'general',
    '[City]', '[County]', true, false, 'local', 40,
    [fee_min], [fee_max], '[app_url]', '[info_url]', '[notes]'
  );
  ```

  **What to avoid:**
  - Do NOT seed data you can't verify — better to have NULL fees than wrong fees
  - Do NOT add county-level requirements yet (keep scope to city business licenses)
  - Do NOT modify LicenseFinder.jsx — the frontend already sends city/county to the webhook
  - City names MUST exactly match the strings in the `CA_CITIES` array in LicenseFinder.jsx (case-sensitive)
  </action>
  <verify>
  Run count and sample queries via SSH:
  ```sql
  -- Total city-specific licenses
  SELECT COUNT(*) FROM license_requirements WHERE city IS NOT NULL;
  -- Should be >= 25

  -- Sample: Los Angeles
  SELECT license_name, city, county, application_fee_min, application_url
  FROM license_requirements
  WHERE city = 'Los Angeles';

  -- Verify city names match frontend (spot check)
  SELECT DISTINCT city FROM license_requirements WHERE city IS NOT NULL ORDER BY city;
  ```
  </verify>
  <done>
  - At least 25 city-specific business license rows inserted (one per target city)
  - Corresponding city agencies added to license_agencies
  - All city names match LicenseFinder.jsx CA_CITIES array exactly
  - Fee data populated where available, NULL with notes where not
  - Fire permits added for cities that require separate fire clearance
  </done>
</task>

<task type="auto">
  <name>Task 2: Update n8n dedup logic and verify end-to-end</name>
  <files>n8n workflow (bizbot-license-finder) — "Process & Enrich Licenses" Code node</files>
  <action>
  1. Get the current n8n workflow (use n8n MCP tools or SSH + n8n API).

  2. In the "Process & Enrich Licenses" Code node, find the section that hardcodes the City Business License entry. It currently adds a generic city license for ALL queries:
     ```javascript
     // City Business License (always added)
     { license_name: 'City Business License', fee_range: '$50-$500', ... }
     ```

  3. Add dedup logic: check if the DB query already returned a city-specific business license before adding the generic one. Pattern:
     ```javascript
     // Check if DB returned a city-specific business license
     const hasCityLicense = dbResults.some(r =>
       r.license_code && r.license_code.startsWith('city_biz_lic_')
     );

     // Only add generic City Business License if no city-specific match
     if (!hasCityLicense) {
       enrichedLicenses.push({
         license_name: 'City Business License',
         // ... existing generic entry
       });
     }
     ```

  4. Push the updated workflow back via n8n MCP tools or API.

  5. Verify end-to-end by testing the webhook with different scenarios via SSH + docker exec (internal access, since external POST is blocked by WAF):

     **Test A — City with specific data (Los Angeles, food industry):**
     ```bash
     ssh vps "docker exec -i n8n-n8n-1 wget -qO- --post-data='{\"industry\":\"food\",\"city\":\"Los Angeles\",\"county\":\"Los Angeles\",\"hasEmployees\":true,\"sellsTangibleGoods\":true,\"entityType\":\"llc\",\"isNew\":true}' --header='Content-Type: application/json' http://localhost:5678/webhook/bizbot-license-finder"
     ```
     Expected: Returns "Los Angeles Business Tax Registration Certificate" (city-specific) — NOT generic "City Business License"

     **Test B — City without specific data (small city, food industry):**
     ```bash
     ssh vps "docker exec -i n8n-n8n-1 wget -qO- --post-data='{\"industry\":\"food\",\"city\":\"Piedmont\",\"county\":\"Alameda\",\"hasEmployees\":false,\"sellsTangibleGoods\":true,\"entityType\":\"sole_proprietorship\",\"isNew\":true}' --header='Content-Type: application/json' http://localhost:5678/webhook/bizbot-license-finder"
     ```
     Expected: Returns generic "City Business License ($50-$500)" — city not in seeded data

     **Test C — No city selected (county only):**
     ```bash
     ssh vps "docker exec -i n8n-n8n-1 wget -qO- --post-data='{\"industry\":\"construction\",\"county\":\"Sacramento\",\"hasEmployees\":true,\"sellsTangibleGoods\":false,\"entityType\":\"llc\",\"isNew\":true}' --header='Content-Type: application/json' http://localhost:5678/webhook/bizbot-license-finder"
     ```
     Expected: Returns generic "City Business License" (no city specified) + general licenses (Workers Comp, IIPP from 07-01 fix)

     **Test D — General licenses appear (verify 07-01 fix):**
     Check that all 3 test responses include general licenses (Workers Comp, IIPP, DBA, SOI, BPP) where conditions are met.

  **What to avoid:**
  - Do NOT remove the generic City Business License fallback entirely — it's the safety net for 457 cities not in our seeded data
  - Do NOT modify the SQL query in the Postgres node (that was done in 07-01)
  - Do NOT change the webhook response shape — frontend expects the same JSON structure
  </action>
  <verify>
  All 4 test scenarios return expected results:
  - Test A: city-specific license, no generic duplicate
  - Test B: generic City Business License (fallback)
  - Test C: generic City Business License (no city)
  - Test D: general licenses present in all responses (where conditions met)
  </verify>
  <done>
  - n8n Code node has dedup logic for city-specific vs generic business license
  - City-specific queries return real fee/URL data instead of generic placeholder
  - Non-seeded cities still get generic fallback
  - No-city queries still get generic fallback
  - General licenses (from 07-01) appear correctly in all test scenarios
  - ISS-003 resolved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] >= 25 city-specific license rows in DB
- [ ] City agencies added to license_agencies
- [ ] n8n Code node dedup logic prevents duplicate city licenses
- [ ] City-specific query returns real data (Test A passes)
- [ ] Fallback works for non-seeded cities (Test B passes)
- [ ] No-city queries work correctly (Test C passes)
- [ ] General licenses from 07-01 appear in results (Test D passes)
- [ ] No regressions to existing webhook response shape
</verification>

<success_criteria>
- ISS-003 resolved: top 25 CA metros have city-specific license data
- License Finder returns accurate city-specific fees and URLs for seeded cities
- Generic fallback preserved for all other cities
- n8n workflow correctly deduplicates city-specific vs generic entries
- Phase 7 complete (both ISS-002 and ISS-003 addressed)
</success_criteria>

<output>
After completion, create `.planning/phases/07-license-data-expansion/07-02-SUMMARY.md`
</output>
