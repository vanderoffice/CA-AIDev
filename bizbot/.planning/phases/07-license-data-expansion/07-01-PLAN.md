---
phase: 07-license-data-expansion
plan: 01
type: execute
---

<objective>
Fix cross-industry general license inclusion (ISS-002) and expand the general license seed data with additional cross-industry requirements.

Purpose: Workers Comp and IIPP are seeded with `industry_code = 'general'` but never returned because the n8n query only matches the specific industry code or `'other'`. This plan fixes the WHERE clause and adds more general licenses that apply to all California businesses.
Output: Updated n8n workflow SQL, updated `get_required_licenses()` DB function, and 3+ new general license rows in `license_requirements`.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md

# Prior phase context (license DB established here):
@.planning/phases/03-tool-rebuilds/03-02-SUMMARY.md

# Schema and seed data (read-only reference):
@BizBot_v4/database/03_license_requirements.sql
@BizBot_v4/database/04_seed_data.sql

# n8n workflow (read-only reference):
@BizBot_v4/workflows/07_license_finder_webhook.json

**Production-first doctrine:** All changes on VPS via SSH.
- DB changes: `ssh vps "docker exec -i supabase-db psql -U postgres -d postgres"`
- n8n workflow: Use n8n MCP tools (`n8n_get_workflow` → modify → `n8n_update_full_workflow`) or n8n API via SSH
- Build (if needed): `ssh vps "cd /root/vanderdev-website && npm run build"`

**Tech stack available:** Supabase PostgreSQL, n8n webhooks, React/Vite
**Established patterns:** PHASE_CONFIG constants, safe fetch pattern, production-first SSH

**Constraining decisions:**
- Phase 3: Industry subcategory → parent category mapping (frontend sends parent code)
- Phase 3: Entity type value alignment (sole_proprietor → sole_proprietorship)
- ISS-001 resolution: 17 agencies, 31 licenses across 9 categories already seeded

**Issues being addressed:** ISS-002 (general licenses not auto-included)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix n8n SQL WHERE clause and DB function to include general licenses</name>
  <files>n8n workflow (bizbot-license-finder), get_required_licenses() DB function</files>
  <action>
  1. Get the current n8n workflow for `bizbot-license-finder` (use n8n MCP tools or SSH + n8n API).

  2. In the "Query License Requirements" Postgres node, the current WHERE clause is:
     ```sql
     WHERE (r.industry_code = $1 OR r.industry_code = 'other')
     ```
     Change to:
     ```sql
     WHERE (r.industry_code = $1 OR r.industry_code = 'general' OR r.industry_code = 'other')
     ```
     This ensures general licenses (Workers Comp, IIPP, and any future general entries) are returned for ALL industry queries.

  3. Update the `get_required_licenses()` DB function similarly — add `OR r.industry_code = 'general'` to its WHERE clause. Run via SSH:
     ```sql
     CREATE OR REPLACE FUNCTION get_required_licenses(...)
     ```
     Preserve all existing function logic; only modify the WHERE filter.

  4. Verify existing general licenses have correct conditional flags:
     - Workers' Compensation Insurance: `is_conditional = true`, `condition_description` should reference employer requirement
     - IIPP: `is_conditional = true`, `condition_description` should reference employer requirement
     If flags are wrong, UPDATE them.

  **What to avoid:** Do NOT modify the n8n "Process & Enrich Licenses" Code node in this task — that's Plan 07-02 scope. Do NOT change the ORDER BY or JOIN clauses.
  </action>
  <verify>
  SSH to VPS and run a test query against the DB:
  ```sql
  SELECT r.license_name, r.industry_code, r.is_conditional, r.condition_description
  FROM license_requirements r
  WHERE (r.industry_code = 'food' OR r.industry_code = 'general' OR r.industry_code = 'other')
  ORDER BY r.sequence_order, r.license_name;
  ```
  Confirm Workers Comp and IIPP appear in results alongside food industry licenses.
  </verify>
  <done>
  - n8n Postgres node WHERE clause includes `r.industry_code = 'general'`
  - `get_required_licenses()` function includes `r.industry_code = 'general'`
  - Workers Comp and IIPP have correct `is_conditional` flags
  - Test query returns general licenses alongside industry-specific ones
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand general license seed data with cross-industry requirements</name>
  <files>license_requirements table (via SSH psql)</files>
  <action>
  INSERT new general/cross-industry license requirements into `license_requirements`. These apply to most/all California businesses regardless of industry.

  **New general licenses to add:**

  1. **Fictitious Business Name Statement (DBA)**
     - `license_code`: 'dba_statement'
     - `agency_code`: 'county_clerk' (add to `license_agencies` if not present — agency_type: 'county')
     - `industry_code`: 'general'
     - `is_statewide`: true (filed at county level but required statewide)
     - `is_conditional`: true
     - `condition_description`: 'Required when operating under a name other than your legal name'
     - `sequence_group`: 'formation'
     - `sequence_order`: 15
     - `application_fee_min/max`: 10/50 (varies by county)
     - `info_url`: 'https://www.sos.ca.gov/business-programs/business-entities/statements'
     - `notes`: 'Must also publish in local newspaper ($30-$100). Filed with county clerk. Expires after 5 years.'

  2. **Statement of Information (SOS)**
     - `license_code`: 'soi_filing'
     - `agency_code`: 'sos'
     - `industry_code`: 'general'
     - `is_statewide`: true
     - `is_conditional`: true
     - `condition_description`: 'Required for LLCs (biennial) and Corporations (annual); not required for sole proprietorships'
     - `sequence_group`: 'ongoing'
     - `sequence_order`: 80
     - `application_fee_min/max`: 20/25 ($20 LLC, $25 Corp)
     - `application_url`: 'https://bizfileonline.sos.ca.gov/'
     - `info_url`: 'https://www.sos.ca.gov/business-programs/business-entities/statements'
     - `notes`: 'LLC: due within 90 days of formation, then biennial. Corp: due within 90 days, then annual.'

  3. **Business Personal Property Statement (BOE-571-L)**
     - `license_code`: 'bpp_statement'
     - `agency_code`: 'county_assessor' (add to `license_agencies` if not present — agency_type: 'county')
     - `industry_code`: 'general'
     - `is_statewide`: true
     - `is_conditional`: true
     - `condition_description`: 'Required for businesses with assessable personal property (equipment, fixtures, supplies)'
     - `sequence_group`: 'ongoing'
     - `sequence_order`: 85
     - `application_fee_min/max`: 0/0 (no filing fee — triggers property tax assessment)
     - `info_url`: 'https://www.boe.ca.gov/proptaxes/bpp.htm'
     - `notes`: 'Filed annually with county assessor by April 1. Covers furniture, equipment, computers, supplies. Late filing penalty: 10% of assessed value.'

  **For each new agency** (county_clerk, county_assessor): INSERT into `license_agencies` first if not already present, with appropriate `agency_type = 'county'`.

  **What to avoid:** Do NOT duplicate licenses that are already hardcoded in the n8n Code node (City Business License, Seller's Permit, EDD Registration, EIN, Formation articles). Those are computed dynamically based on user answers. Do NOT add federal-only requirements (ADA) — keep focus on CA state requirements.
  </action>
  <verify>
  Run count and listing queries via SSH:
  ```sql
  SELECT COUNT(*) FROM license_requirements WHERE industry_code = 'general';
  -- Should return 5 (2 existing + 3 new)

  SELECT license_name, license_code, is_conditional, sequence_group
  FROM license_requirements
  WHERE industry_code = 'general'
  ORDER BY sequence_order;
  -- Should show Workers Comp, IIPP, DBA, SOI, BPP
  ```
  </verify>
  <done>
  - 3 new general license rows inserted (DBA, SOI, BPP)
  - Any new agencies (county_clerk, county_assessor) added to license_agencies
  - All new rows have correct conditional flags, fees, URLs, and sequence groups
  - Total general licenses = 5
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] n8n workflow updated with `OR r.industry_code = 'general'` in Postgres node
- [ ] `get_required_licenses()` DB function updated
- [ ] 5 total general licenses in DB (2 existing + 3 new)
- [ ] Test query for any industry returns general licenses alongside industry-specific ones
- [ ] Workers Comp/IIPP conditional flags verified
- [ ] New agencies (if added) present in license_agencies
</verification>

<success_criteria>
- ISS-002 resolved: general licenses auto-included in all industry queries
- General license catalog expanded from 2 to 5 cross-industry requirements
- All new data has proper fees, URLs, conditional flags, and sequence ordering
- No regressions to existing license queries
</success_criteria>

<output>
After completion, create `.planning/phases/07-license-data-expansion/07-01-SUMMARY.md`
</output>
