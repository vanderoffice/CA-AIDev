---
phase: 09-tooling-verification
plan: 01
type: execute
---

<objective>
Fix nginx WAF blocking external POST to n8n webhooks (ISS-004) and run final eval pass to validate all v1.1 Data Completeness changes.

Purpose: Close out the last open issue from v1.1 and confirm zero regressions from Phases 7-8 (license expansion + RAG pipeline improvements).
Output: Working external webhook access, final eval report, ISS-004 closed, v1.1 milestone ready to close.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/ISSUES.md

# Prior phase summaries (dependency graph):
@.planning/phases/05-integration-testing/05-01-SUMMARY.md
@.planning/phases/08-rag-pipeline-improvements/08-03-SUMMARY.md

# Key files on VPS (read via SSH):
# /etc/nginx/sites-enabled/* — nginx reverse proxy configs for n8n
# /root/vanderdev-website/ — production repo

**Baseline to compare against (Phase 5 final):**
- Coverage: 100.0%
- STRONG: 29, ACCEPTABLE: 6, WEAK: 0
- Webhook score: 100/100

**ISS-004 context:**
- External POST to `n8n.vanderdev.net/webhook/*` returns 403 Forbidden
- Introduced during VPS production hardening (rate limiting / WAF rules)
- Webhooks healthy internally via `docker exec`
- Current workaround: audit-webhooks.py uses SSH + docker exec instead of direct HTTP

**Constraining decisions:**
- Production-first: all VPS work via SSH
- VPS hardening added security headers, rate limiting, WAF — one of these blocks external POST
- Phase 5: "WAF 403 is infrastructure, not webhook issue" — confirmed internal access works fine
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix nginx WAF external POST blocking for n8n webhooks (ISS-004)</name>
  <files>/etc/nginx/sites-enabled/* (VPS), potentially /etc/nginx/conf.d/*</files>
  <action>
SSH to VPS and diagnose which nginx config rule blocks external POST to n8n webhooks:

1. Find the n8n reverse proxy config:
   `ssh vps "grep -r 'n8n' /etc/nginx/sites-enabled/ /etc/nginx/conf.d/ 2>/dev/null"`

2. Look for rules that could cause 403 on POST: `limit_except`, `if ($request_method`, WAF deny rules, `allow/deny` blocks, or ModSecurity/NAXSI rules targeting POST.

3. Fix: Allow POST requests to the `/webhook/` path. The fix depends on what's found:
   - If `limit_except GET`: add POST to allowed methods
   - If IP allow/deny block: add an exception for webhook paths
   - If rate limiting is too aggressive on POST: adjust rate for webhook location
   - Do NOT disable WAF/security globally — only open the specific webhook path

4. Reload nginx: `ssh vps "nginx -t && systemctl reload nginx"`

5. Test from local machine:
   `curl -s -o /dev/null -w "%{http_code}" -X POST -H "Content-Type: application/json" -d '{"message":"test"}' https://n8n.vanderdev.net/webhook-test/bizbot`
   Expected: 200 (not 403)

IMPORTANT: Do NOT weaken overall VPS security. Only adjust the rule for the n8n webhook path. If the fix is unclear or risky, document findings and present options.
  </action>
  <verify>
curl -X POST from local machine to `https://n8n.vanderdev.net/webhook-test/bizbot` returns 200 (or valid n8n response), not 403.
  </verify>
  <done>External POST to n8n webhook endpoints no longer blocked by nginx. Internal and external access both work. nginx -t passes, reload successful.</done>
</task>

<task type="auto">
  <name>Task 2: Run final v1.1 eval and update project state</name>
  <files>.planning/ISSUES.md, .planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
1. Run bot-eval on BizBot to capture post-v1.1 metrics. Use the same eval approach from Phase 5 — embedding eval across all query categories (licensing, industry, entity, compliance, adversarial).

2. Compare results against Phase 5 baseline:
   - Coverage: expect >= 100.0%
   - STRONG: expect >= 29
   - ACCEPTABLE + STRONG: expect >= 35
   - WEAK: expect 0

3. If external webhook access now works (Task 1), also run webhook audit via direct HTTP (not docker exec workaround) to confirm all 3 endpoints respond:
   - /webhook/bizbot
   - /webhook/bizbot-licenses
   - /webhook/bizbot-license-finder

4. Update ISSUES.md: Close ISS-004 with resolution details.

5. Update STATE.md:
   - Current position: Phase 9 complete
   - Progress: 100%
   - Move ISS-004 from open to resolved
   - Record final eval metrics

6. Update ROADMAP.md:
   - Mark 09-01 as complete
   - Mark Phase 9 as complete
   - Update progress table
  </action>
  <verify>
Bot-eval report shows >= 100% coverage with 0 WEAK scores. ISSUES.md shows ISS-004 resolved. STATE.md and ROADMAP.md reflect Phase 9 and v1.1 status.
  </verify>
  <done>Final eval confirms zero regressions from v1.1 changes. ISS-004 closed. STATE.md and ROADMAP.md updated. Phase 9 complete.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] External POST to n8n webhook returns 200 (not 403)
- [ ] nginx -t passes on VPS
- [ ] Bot-eval coverage >= 100%, WEAK = 0
- [ ] All 3 webhook endpoints respond to external POST
- [ ] ISS-004 closed in ISSUES.md
- [ ] STATE.md reflects Phase 9 complete, 100% progress
- [ ] ROADMAP.md reflects Phase 9 complete
</verification>

<success_criteria>

- ISS-004 resolved — external POST to n8n webhooks works
- Final eval confirms zero regressions from Phases 7-8
- All project tracking files updated
- Phase 9 complete, v1.1 milestone ready for close-out
</success_criteria>

<output>
After completion, create `.planning/phases/09-tooling-verification/09-01-SUMMARY.md`:

# Phase 9 Plan 1: WAF Fix + Final v1.1 Eval Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [nginx fix details]
- [eval results vs baseline]

## Files Created/Modified

- [nginx config path] - [what changed]
- `.planning/ISSUES.md` - ISS-004 closed
- `.planning/STATE.md` - Phase 9 complete
- `.planning/ROADMAP.md` - Phase 9 + v1.1 status

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 9 complete. Run `/gsd:complete-milestone` to close v1.1 Data Completeness milestone.
</output>
